<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>黄金板块量化交易系统</title>
    <script src="./plotly.min.js" onload="console.log('✅ plotly.min.js 脚本加载完成')" onerror="console.error('❌ plotly.min.js 脚本加载失败')">
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #ff6b6b, #ffa500);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .main-content {
            padding: 40px;
        }

        /* 模块样式 */
        .module {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            border: 2px solid #e9ecef;
        }

        .module h2 {
            color: #333;
            margin-bottom: 25px;
            font-size: 1.5em;
            border-bottom: 3px solid #ff6b6b;
            padding-bottom: 10px;
        }

        /* 基础信息模块样式 */
        .basic-info {
            background: linear-gradient(135deg, #e3f2fd, #f3e5f5);
        }

        .basic-info h2 {
            border-bottom-color: #2196f3;
        }

        /* 相似度分析模块样式 */
        .similarity-analysis {
            background: linear-gradient(135deg, #e8f5e8, #f1f8e9);
        }

        .similarity-analysis h2 {
            border-bottom-color: #4caf50;
        }

        /* 权重配置样式 */
        .weight-config {
            background: rgba(255, 255, 255, 0.7);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border: 2px solid #4caf50;
        }

        .weight-config h3 {
            color: #2e7d32;
            margin-bottom: 15px;
            font-size: 1.3em;
            text-align: center;
        }

        .weight-total {
            text-align: center;
            margin-top: 15px;
            padding: 10px;
            background: rgba(76, 175, 80, 0.1);
            border-radius: 5px;
            border: 1px solid #4caf50;
        }

        .weight-status-ok {
            color: #4caf50;
            margin-left: 10px;
        }

        .weight-status-error {
            color: #f44336;
            margin-left: 10px;
        }

        /* 交易策略参数样式 */
        .strategy-info {
            padding: 8px 12px;
            background: rgba(255, 193, 7, 0.1);
            border-radius: 5px;
            border: 1px solid #ffc107;
        }

        .strategy-info small {
            color: #856404;
            font-style: italic;
        }

        .parameter-description {
            font-size: 0.9em;
            color: #666;
            margin-top: 4px;
            font-style: italic;
        }

        /* 交易策略模块样式 */
        .trading-strategy {
            background: linear-gradient(135deg, #fff3e0, #fce4ec);
        }

        .trading-strategy h2 {
            border-bottom-color: #ff9800;
        }

        /* 表单样式 */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-weight: bold;
            margin-bottom: 8px;
            color: #333;
            font-size: 1.1em;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        select, input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        select:focus, input:focus {
            outline: none;
            border-color: #ff6b6b;
            box-shadow: 0 0 0 3px rgba(255, 107, 107, 0.1);
        }

        /* 按钮样式 */
        .btn {
            background: linear-gradient(135deg, #ff6b6b, #ffa500);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin: 5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(255, 107, 107, 0.3);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-similarity {
            background: linear-gradient(135deg, #667eea, #764ba2);
        }

        .btn-strategy {
            background: linear-gradient(135deg, #ff9800, #f57c00);
        }

        /* 数据展示区域 */
        .data-display {
            background: white;
            border-radius: 10px;
            padding: 25px;
            margin-top: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .data-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .data-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #ff6b6b;
            text-align: center;
        }

        .data-item .label {
            font-weight: bold;
            color: #666;
            font-size: 0.9em;
            margin-bottom: 5px;
        }

        .data-item .value {
            font-size: 1.2em;
            color: #333;
            font-weight: bold;
        }

        .data-item.positive .value {
            color: #dc3545;
        }

        .data-item.negative .value {
            color: #28a745;
        }

        /* 图表容器 */
        .chart-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
            width: 100%;
            min-height: 800px; /* 增加高度以显示完整的K线图 */
        }

        #chartContainer, #similarityChartContainer {
            width: 100% !important;
            min-width: 100%;
            height: 800px !important; /* 固定高度确保完整显示 */
        }

        /* 相似度分析结果 */
        .similarity-result {
            background: white;
            border-radius: 10px;
            padding: 25px;
            margin-top: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .similarity-score {
            text-align: center;
            margin-bottom: 30px;
        }

        .score-circle {
            display: inline-block;
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: linear-gradient(135deg, #4caf50, #8bc34a);
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            margin: 0 auto 20px;
            box-shadow: 0 10px 30px rgba(76, 175, 80, 0.3);
        }

        .score-circle.low {
            background: linear-gradient(135deg, #f44336, #ff5722);
        }

        .score-circle.medium {
            background: linear-gradient(135deg, #ff9800, #ffc107);
        }

        .score-value {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .score-label {
            font-size: 1em;
            opacity: 0.9;
        }

        .dimension-scores {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .dimension-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border-left: 4px solid #007bff;
        }

        .dimension-item .score {
            font-size: 1.5em;
            font-weight: bold;
            color: #007bff;
            margin-bottom: 5px;
        }

        .dimension-item .label {
            font-size: 0.9em;
            color: #666;
        }

        /* 策略执行结果 */
        .strategy-result {
            background: white;
            border-radius: 10px;
            padding: 25px;
            margin-top: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .strategy-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            border-left: 4px solid #ff6b6b;
        }

        .stat-card .value {
            font-size: 2em;
            font-weight: bold;
            color: #ff6b6b;
            margin-bottom: 5px;
        }

        .stat-card .label {
            color: #666;
            font-size: 0.9em;
        }

        /* 加载状态 */
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #ff6b6b;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* 错误和成功消息 */
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #f5c6cb;
            margin-top: 15px;
        }

        .success {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #c3e6cb;
            margin-top: 15px;
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .main-content {
                padding: 20px;
            }

            .data-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            }
        }

        /* 隐藏元素 */
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🏆 黄金板块量化交易系统</h1>
            <p>基于伦敦金价涨跌的智能交易策略分析平台</p>
        </div>

        <div class="main-content">
            <!-- 基础信息模块 -->
            <div class="module basic-info">
                <h2>📊 基础信息模块</h2>
                
                <!-- 参数配置 -->
                    <div class="form-row">
                        <div class="form-group">
                        <label for="stockSelect">选择股票</label>
                            <select id="stockSelect" name="stock_code">
                                <option value="">正在加载股票列表...</option>
                            </select>
                            <div class="parameter-description">选择一只股票</div>
                        </div>
                        <div class="form-group">
                            <label for="analysisMonths">分析时间范围</label>
                            <select id="analysisMonths" name="analysis_months">
                                <option value="1">1个月</option>
                                <option value="2">2个月</option>
                                <option value="3">3个月</option>
                                <option value="6" selected>6个月</option>
                                <option value="12">12个月</option>
                                <option value="24">24个月</option>
                            </select>
                            <div class="parameter-description">选择分析的时间范围</div>
                        </div>
                        <div class="form-group">
                            <label for="initInvestment">初始资金 (元)</label>
                            <input type="number" id="initInvestment" name="init_investment" value="10000" min="1000" step="1000">
                            <div class="parameter-description">建仓的金额</div>
                        </div>
                    </div>
                    
                <!-- 操作按钮 -->
                <div style="text-align: center; margin: 20px 0;">
                    <button type="button" class="btn" id="analyzeBtn" onclick="analyzeStock()">
                        📈 查看基础信息
                    </button>
                </div>

                <!-- 实时数据展示 -->
                <div class="data-display" id="basicInfoDisplay" style="display: none;">
                    <h3>📈 实时数据</h3>
                    <div class="data-grid" id="basicInfoGrid">
                        <!-- 数据将通过JavaScript动态填充 -->
                    </div>
                </div>

                <!-- K线图展示 -->
                <div class="chart-container" id="chartSection" style="display: none;">
                    <div id="chartContainer" style="width: 100%; height: 600px;">
                        <!-- Plotly图表将在这里显示 -->
                    </div>
                </div>
            </div>

            <!-- 相似度分析模块 -->
            <div class="module similarity-analysis">
                <h2>🔍 相似度分析模块</h2>
                
                <!-- 基础参数配置 -->
                <div class="form-row">
                    <div class="form-group">
                        <label for="windowSize">滑动窗口大小</label>
                        <select id="windowSize" name="window_size">
                            <option value="2" selected>2天</option>
                            <option value="3">3天</option>
                            <option value="5">5天</option>
                            <option value="7">7天</option>
                            <option value="10">10天</option>
                            <option value="15">20天</option>
                        </select>
                        <div class="parameter-description">将时间序列数据分割成固定大小的窗口，在每个窗口内计算相似度，窗口越小越敏感</div>
                    </div>
                    <div class="form-group">
                        <label for="maWindow">移动平均线窗口</label>
                        <select id="maWindow" name="ma_window">
                            <option value="5" selected>MA5</option>
                            <option value="10">MA10</option>
                            <option value="20">MA20</option>
                        </select>
                        <div class="parameter-description">计算多条移动平均线（MA5、MA10、MA20）的相似度，用于趋势分析</div>
                    </div>
                    <div class="form-group">
                        <label for="moveDay">平移天数</label>
                        <input type="number" id="moveDay" name="move_day" value="1" min="-3" max="3" step="1">
                        <div class="parameter-description">伦敦金价通常领先国内股市，正数表示用前几天的金价数据，负数表示用后几天的金价数据</div>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="dataMissing">数据缺失处理</label>
                        <select id="dataMissing" name="data_missing">
                            <option value="0">不处理</option>
                            <option value="1" selected>跳过</option>
                            <option value="2">用前一天数据填充</option>
                        </select>
                        <div class="parameter-description">处理伦敦金价和A股交易日不匹配的问题，跳过缺失数据或使用前向填充</div>
                    </div>
                </div>

                <!-- 权重配置参数 -->
                <div class="weight-config">
                    <h3>📊 相似度权重配置</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="correlationWeight">价格变化相关性权重 (%)</label>
                            <input type="number" id="correlationWeight" name="correlation_weight" value="30" min="0" max="100" step="5" onchange="updateWeightTotal()">
                            <div class="parameter-description">计算金价和股价日涨跌幅的皮尔逊相关系数，衡量价格变化的同步性</div>
                        </div>

                        <div class="form-group">
                            <label for="trendWeight">趋势方向一致性权重 (%)</label>
                            <input type="number" id="trendWeight" name="trend_weight" value="25" min="0" max="100" step="5" onchange="updateWeightTotal()">
                            <div class="parameter-description">比较移动平均线的斜率方向，衡量金价和股价趋势的一致性</div>
                        </div>

                        <div class="form-group">
                            <label for="volatilityWeight">波动性相似度权重 (%)</label>
                            <input type="number" id="volatilityWeight" name="volatility_weight" value="20" min="0" max="100" step="5" onchange="updateWeightTotal()">
                            <div class="parameter-description">比较价格波动幅度和频率，衡量金价和股价波动性的相似程度</div>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="patternWeight">价格模式匹配权重 (%)</label>
                            <input type="number" id="patternWeight" name="pattern_weight" value="15" min="0" max="100" step="5" onchange="updateWeightTotal()">
                            <div class="parameter-description">使用DTW算法计算价格序列相似度，识别金价和股价的价格模式匹配程度</div>
                        </div>

                        <div class="form-group">
                            <label for="volumeWeight">成交量关系权重 (%)</label>
                            <input type="number" id="volumeWeight" name="volume_weight" value="10" min="0" max="100" step="5" onchange="updateWeightTotal()">
                            <div class="parameter-description">分析成交量与价格变化的关系相似度，衡量金价和股价的量价关系一致性</div>
                        </div>
                    </div>
                    
                    <!-- 权重总和显示 -->
                    <div class="weight-total">
                        <strong>权重总和: <span id="weightTotal">100</span>%</strong>
                        <span id="weightStatus" class="weight-status-ok">✓ 权重配置正确</span>
                    </div>
                </div>
                
                <div style="text-align: center; margin: 20px 0;">
                    <button type="button" class="btn btn-similarity" onclick="analyzeSimilarity()">
                        🔍 走势相似度分析
                    </button>
                </div>

                <!-- 相似度分析结果 -->
                <div class="similarity-result" id="similarityResult" style="display: none;">
                    <h3>📊 相似度分析结果</h3>
                    <div class="similarity-score" id="similarityScore">
                        <!-- 相似度分数将通过JavaScript动态填充 -->
                    </div>
                    <div class="dimension-scores" id="dimensionScores">
                        <!-- 各维度分数将通过JavaScript动态填充 -->
                    </div>
                </div>

                <!-- 相似度图表 -->
                <div class="chart-container" id="similarityChartSection" style="display: none;">
                    <div id="similarityChartContainer" style="width: 100%; height: 600px;">
                        <!-- 相似度分析图表将在这里显示 -->
                    </div>
                </div>
            </div>

            <!-- 交易策略执行模块 -->
            <div class="module trading-strategy">
                <h2>🚀 交易策略执行模块</h2>
                
                <!-- 策略参数配置 -->
                    <div class="form-row">
                        <div class="form-group">
                        <label for="baseInvestment">基础投资金额 (元)</label>
                        <input type="number" id="baseInvestment" name="base_investment" value="10000" min="100" step="100">
                        <div class="parameter-description">每次买入金额 = 基础金额 × 金价涨幅</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="stopLossRate">止损率 (%)</label>
                            <input type="number" id="stopLossRate" name="stop_loss_rate" value="10" min="1" max="50" step="1">
                        <div class="parameter-description">当亏损达到此比例时自动卖出</div>
                        </div>
                        
                        <div class="form-group">
                        <label for="maxProfitRate">最大盈利率 (%)</label>
                            <input type="number" id="maxProfitRate" name="max_profit_rate" value="50" min="1" max="100" step="1">
                        <div class="parameter-description">当盈利超过此比例时考虑卖出</div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="profitCallbackRate">盈利回调率 (%)</label>
                                <input type="number" id="profitCallbackRate" name="profit_callback_rate" value="1" min="0.1" max="5" step="0.1">
                            <div class="parameter-description">从最大盈利回调到此比例时卖出</div>
                        </div>
                        <div class="form-group">
                        <label for="minGoldChange">最小金价涨幅阈值 (%)</label>
                            <input type="number" id="minGoldChange" name="min_gold_change" value="0.2" min="0.1" max="10" step="0.1">
                        <div class="parameter-description">只有金价涨幅超过此阈值时才买入</div>
                        </div>
                        
                        <div class="form-group">
                        <label for="minBuyAmount">最小买入金额 (元)</label>
                            <input type="number" id="minBuyAmount" name="min_buy_amount" value="100" min="100" max="10000" step="100">
                        <div class="parameter-description">每次买入金额不能小于此值</div>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                        <label for="transactionCostRate">交易成本率 (%)</label>
                            <input type="number" id="transactionCostRate" name="transaction_cost_rate" value="0.1" min="0.01" max="1" step="0.01">
                        <div class="parameter-description">每次买入和卖出的手续费比例</div>
                        </div>
                        
                        <div class="form-group">
                        <label for="maxHoldDays">最大持仓天数</label>
                            <input type="number" id="maxHoldDays" name="max_hold_days" value="30" min="1" max="365" step="1">
                        <div class="parameter-description">超过此天数时强制卖出</div>
                        </div>

                        <div class="form-group">
                        <label for="strategyMode">策略模式</label>
                            <select id="strategyMode" name="strategy_mode">
                                <option value="basic">基础模式</option>
                                <option value="improved" selected>改进模式</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- 回测时间范围选择 -->
                    <div class="form-row">
                        <div class="form-group">
                            <label for="backtestMonths">回测时间范围</label>
                            <select id="backtestMonths" name="backtest_months">
                                <option value="1">1个月</option>
                                <option value="3">3个月</option>
                                <option value="6" selected>6个月</option>
                                <option value="12">12个月</option>
                                <option value="24">24个月</option>
                            </select>
                            <div class="parameter-description">选择历史回测的时间范围</div>
                        </div>
                    </div>
                    
                <!-- 操作按钮 -->
                <div style="text-align: center; margin: 20px 0;">
                    <button type="button" class="btn btn-strategy" onclick="executeStrategy()">
                        🚀 执行策略
                    </button>
                    <button type="button" class="btn btn-strategy" onclick="runBacktest()">
                        📊 历史回测
                    </button>
            </div>

                <!-- 策略执行结果 -->
                <div class="strategy-result" id="strategyResult" style="display: none;">
                    <h3>📋 策略执行结果</h3>
                    <div class="strategy-stats" id="strategyStats">
                        <!-- 策略统计将通过JavaScript动态填充 -->
                        </div>
                        </div>

                <!-- 策略图表 -->
                <div class="chart-container" id="strategyChartSection" style="display: none;">
                    <div id="strategyChartContainer" style="width: 100%; height: 600px;">
                        <!-- 策略图表将在这里显示 -->
                    </div>
                </div>
            </div>

            <!-- 加载状态 -->
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>正在处理数据，请稍候...</p>
            </div>
        </div>
    </div>

    <script>
        // 全局变量
        let currentStatus = null;
        let statusUpdateInterval = null;
        let autoRefreshInterval = null;

        // DOM元素
        let loading, analyzeBtn;

        // DOM元素获取函数
        function getElementById(id) {
            return document.getElementById(id);
        }

        // 获取表单数据
        function getFormData() {
            return {
                stockCode: getElementById('stockSelect').value,
                months: parseInt(getElementById('analysisMonths').value),
                stockName: getElementById('stockSelect').selectedOptions[0].text,
                baseInvestment: parseFloat(getElementById('baseInvestment').value),
                stopLossRate: parseFloat(getElementById('stopLossRate').value),
                maxProfitRate: parseFloat(getElementById('maxProfitRate').value),
                profitCallbackRate: parseFloat(getElementById('profitCallbackRate').value),
                minGoldChange: parseFloat(getElementById('minGoldChange').value),
                minBuyAmount: parseFloat(getElementById('minBuyAmount').value),
                transactionCostRate: parseFloat(getElementById('transactionCostRate').value),
                maxHoldDays: parseInt(getElementById('maxHoldDays').value),
                strategyMode: getElementById('strategyMode').value,
                backtestMonths: parseInt(getElementById('backtestMonths').value)
            };
        }

        // 加载股票列表
        async function loadStockList() {
            try {
                console.log('🔄 正在加载股票列表...');
                const response = await makeApiRequest('/api/stock_list');
                
                if (response && Array.isArray(response)) {
                    const stockSelect = getElementById('stockSelect');
                    stockSelect.innerHTML = ''; // 清空现有选项
                    
                    // 添加默认选项
                    const defaultOption = document.createElement('option');
                    defaultOption.value = '';
                    defaultOption.textContent = '请选择股票';
                    stockSelect.appendChild(defaultOption);
                    
                    // 添加股票选项
                    response.forEach((stock, index) => {
                        const option = document.createElement('option');
                        option.value = stock.code;
                        option.textContent = `${stock.name} (${stock.code})`;
                        
                        // 设置第一个股票为默认选中
                        if (index === 0) {
                            option.selected = true;
                        }
                        
                        stockSelect.appendChild(option);
                    });
                    
                    console.log(`✅ 股票列表加载完成，共 ${response.length} 只股票`);
                } else {
                    console.error('❌ 股票列表数据格式错误');
                    showError('股票列表数据格式错误');
                }
            } catch (error) {
                console.error('❌ 加载股票列表失败:', error);
                showError('加载股票列表失败: ' + error.message);
                
                // 如果加载失败，设置默认股票
                const stockSelect = getElementById('stockSelect');
                stockSelect.innerHTML = `
                    <option value="002155" selected>湖南黄金 (002155)</option>
                    <option value="600547">山东黄金 (600547)</option>
                    <option value="000975">银泰黄金 (000975)</option>
                    <option value="600489">中金黄金 (600489)</option>
                    <option value="002237">恒邦股份 (002237)</option>
                    <option value="600988">赤峰黄金 (600988)</option>
                `;
            }
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 页面DOM加载完成');
            
            // 初始化权重总和显示
            updateWeightTotal();
            
            // 初始化DOM元素
            loading = document.getElementById('loading');
            analyzeBtn = document.getElementById('analyzeBtn');
            
            console.log('DOM元素初始化完成');
            
            // 加载股票列表
            loadStockList().then(() => {
                console.log('✅ 股票列表加载完成，开始初始化页面...');
                
                // 开始自动刷新
                startAutoRefresh();
                
                // 立即显示基础信息
                setTimeout(() => {
                    console.log('🔄 页面初始化，显示基础信息...');
                    showRealtimeDataModule(); // 强制显示模块
                    displayBasicInfo(); // 调用不带参数的函数，让它自己获取数据
                }, 1000);
            }).catch((error) => {
                console.error('❌ 股票列表加载失败，使用默认配置:', error);
                // 即使股票列表加载失败，也继续初始化页面
                startAutoRefresh();
                setTimeout(() => {
                    showRealtimeDataModule();
                    displayBasicInfo();
                }, 1000);
            });
            
            // 添加股票选择变化监听器
            const stockSelect = getElementById('stockSelect');
            stockSelect.addEventListener('change', function() {
                console.log('股票选择变化:', this.value);
                // 强制显示模块并刷新数据
                showRealtimeDataModule();
                displayBasicInfo(); // 调用不带参数的函数，让它自己获取数据
            });
            
            // 检查Plotly库
            checkPlotlyLoaded();
        });

        // 检查Plotly库是否加载
        function checkPlotlyLoaded() {
            let checkCount = 0;
            const maxChecks = 10;
            
            function checkPlotly() {
                if (typeof Plotly !== 'undefined') {
                    console.log('✅ Plotly库检查成功');
                    return;
                } else if (checkCount < maxChecks) {
                    checkCount++;
                    console.log(`⏳ Plotly库未就绪，${500}ms后重试 (${checkCount}/${maxChecks})`);
                    setTimeout(checkPlotly, 500);
                } else {
                    console.error('❌ Plotly库加载超时');
                }
            }
            
            checkPlotly();
        }

        // 开始自动刷新
        function startAutoRefresh() {
            // 每10秒自动刷新数据
            autoRefreshInterval = setInterval(refreshData, 10000);
            console.log('🔄 自动刷新已启动，每10秒刷新一次');
        }

        // 停止自动刷新
        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
                console.log('⏹️ 自动刷新已停止');
            }
        }

        // 显示加载状态
        function showLoading() {
            if (loading) {
                loading.classList.add('show');
            }
            if (analyzeBtn) {
                analyzeBtn.disabled = true;
                analyzeBtn.textContent = '分析中...';
            }
        }

        // 隐藏加载状态
        function hideLoading() {
            if (loading) {
                loading.classList.remove('show');
            }
            if (analyzeBtn) {
                analyzeBtn.disabled = false;
                analyzeBtn.textContent = '📈 开始分析';
            }
        }

        // 分析股票数据
        async function analyzeStock() {
            console.log('🔍 开始分析股票数据...');
            
            try {
                const formData = getFormData();
                const data = {
                    months: formData.months,
                    stock_code: formData.stockCode,
                    stock_name: formData.stockName
                };

                console.log('分析参数:', data);
                showLoading();
                
                const response = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                console.log('分析结果:', result);

                hideLoading();

                if (result.success) {
                    // 显示基础信息
                    displayBasicInfo(result);
                    
                    // 显示K线图
                    if (result.chart_data) {
                        displayChart(result.chart_data, 'chartContainer', 'chartSection');
                    }
                } else {
                    showError('分析失败: ' + result.message);
                }
            } catch (error) {
                console.error('分析错误:', error);
                hideLoading();
                showError('分析失败: ' + error.message);
            }
        }

        // 生成基础信息HTML内容
        function generateBasicInfoHTML(status) {
            // 计算总资产和收益率
            const currentPrice = status.current_price || 0;
            const position = status.position || {};
            const totalShares = status.total_shares || 0;
            const totalAssets = status.total_assets || 0;  // 当前市值
            const totalCost = status.total_cost || 0;
            const profitLoss = totalAssets - totalCost;  // 盈亏金额
            const todayReturn = status.stock_change_rate || 0;  // 使用股价涨跌幅作为今日收益率
            const cumulativeReturn = status.cumulative_return || 0;
            const annualReturn = status.annual_return || 0;
            
            return `
                <div class="data-item">
                    <div class="label">当前股价</div>
                    <div class="value">¥${currentPrice.toFixed(2)}</div>
                </div>
                <div class="data-item ${todayReturn >= 0 ? 'positive' : 'negative'}">
                    <div class="label">股价涨跌</div>
                    <div class="value">${(todayReturn * 100).toFixed(2)}%</div>
                </div>
                <div class="data-item">
                    <div class="label">伦敦金价</div>
                    <div class="value">$${status.gold_price.toFixed(2)}</div>
                </div>
                <div class="data-item ${status.gold_change_rate >= 0 ? 'positive' : 'negative'}">
                    <div class="label">金价涨跌</div>
                    <div class="value">${(status.gold_change_rate * 100).toFixed(2)}%</div>
                </div>
                <div class="data-item">
                    <div class="label">投资成本</div>
                    <div class="value">¥${totalCost.toLocaleString()}</div>
                </div>
                <div class="data-item">
                    <div class="label">总持股数</div>
                    <div class="value">${totalShares.toFixed(2)}股</div>
                </div>
                <div class="data-item">
                    <div class="label">总资产（当前市值）</div>
                    <div class="value">¥${totalAssets.toLocaleString()}</div>
                </div>
                <div class="data-item ${profitLoss >= 0 ? 'positive' : 'negative'}">
                    <div class="label">盈亏金额</div>
                    <div class="value">¥${profitLoss.toLocaleString()}</div>
                </div>
                <div class="data-item ${todayReturn >= 0 ? 'positive' : 'negative'}">
                    <div class="label">今日收益率</div>
                    <div class="value">${(todayReturn * 100).toFixed(2)}%</div>
                </div>
                <div class="data-item ${cumulativeReturn >= 0 ? 'positive' : 'negative'}">
                    <div class="label">累计收益率</div>
                    <div class="value">${(cumulativeReturn * 100).toFixed(2)}%</div>
                </div>
                <div class="data-item ${annualReturn >= 0 ? 'positive' : 'negative'}">
                    <div class="label">年化收益率</div>
                    <div class="value">${(annualReturn * 100).toFixed(2)}%</div>
                </div>
            `;
        }

        // 显示基础信息（使用传入的状态数据）
        async function displayBasicInfoWithStatus(status) {
            const basicInfoDisplay = getElementById('basicInfoDisplay');
            const basicInfoGrid = getElementById('basicInfoGrid');
            
            try {
                console.log('使用传入的状态数据:', status);
                console.log('JSON数据调试:', {
                    total_cost: status.total_cost,
                    total_shares: status.total_shares,
                    cumulative_return: status.cumulative_return,
                    annual_return: status.annual_return
                });
                
                console.log('股价数据调试:', {
                    currentPrice: status.current_price,
                    stockChangeRate: status.stock_change_rate,
                    goldPrice: status.gold_price,
                    goldChangeRate: status.gold_change_rate
                });
                
                basicInfoGrid.innerHTML = generateBasicInfoHTML(status);
                basicInfoDisplay.style.display = 'block';
            } catch (error) {
                console.error('显示基础信息失败:', error);
                showError('显示基础信息失败: ' + error.message);
            }
        }

        // 强制显示实时数据模块
        function showRealtimeDataModule() {
            const basicInfoDisplay = getElementById('basicInfoDisplay');
            if (basicInfoDisplay) {
                basicInfoDisplay.style.display = 'block';
                console.log('✅ 强制显示实时数据模块');
            } else {
                console.error('❌ 找不到实时数据模块元素');
            }
        }

        // 显示基础信息
        async function displayBasicInfo(result) {
            console.log('🔄 开始显示基础信息...');
            const basicInfoDisplay = getElementById('basicInfoDisplay');
            const basicInfoGrid = getElementById('basicInfoGrid');
            
            console.log('🔍 DOM元素检查:', {
                basicInfoDisplay: basicInfoDisplay,
                basicInfoGrid: basicInfoGrid
            });
            
            console.log('🔍 股票选择器检查:', {
                stockSelect: getElementById('stockSelect'),
                selectedValue: getElementById('stockSelect')?.value
            });
            
            try {
                // 从API获取真实的状态数据
                const formData = getFormData();
                console.log('🔍 当前选择的股票代码:', formData.stockCode);
                
                if (!formData.stockCode) {
                    console.error('❌ 股票代码为空');
                    showError('请选择股票');
                    return;
                }

                console.log('📡 正在请求API...');
                const response = await fetch(`/api/current_status?stock_code=${formData.stockCode}`);
                console.log('📡 API响应状态:', response.status);
                
                const status = await response.json();
                console.log('📊 获取到的状态数据:', status);
                
                if (status.error) {
                    console.error('❌ 获取状态失败:', status.error);
                    showError('获取实时数据失败: ' + status.error);
                    return;
                }
                
                console.log('📊 计算后的数据:', {
                    currentPrice: status.current_price,
                    stockChangeRate: status.stock_change_rate,
                    goldPrice: status.gold_price,
                    goldChangeRate: status.gold_change_rate,
                    totalShares: status.total_shares,
                    totalAssets: status.total_assets,
                    totalCost: status.total_cost,
                    cumulativeReturn: status.cumulative_return,
                    annualReturn: status.annual_return
                });
                
                console.log('🎨 开始生成HTML内容...');
                basicInfoGrid.innerHTML = generateBasicInfoHTML(status);
                basicInfoDisplay.style.display = 'block';
                console.log('✅ 实时数据模块已显示');
                console.log('🔍 模块内容检查:', {
                    innerHTML: basicInfoGrid.innerHTML.substring(0, 100) + '...',
                    display: basicInfoDisplay.style.display,
                    visible: basicInfoDisplay.offsetHeight > 0
                });
            } catch (error) {
                console.error('获取基础信息失败:', error);
                showError('获取基础信息失败: ' + error.message);
            }
        }

        // 显示图表
        function displayChart(chartData, containerId, sectionId) {
            try {
                if (typeof Plotly === 'undefined') {
                    console.error('❌ Plotly库未加载');
                return;
            }
            
                const container = getElementById(containerId);
                const section = getElementById(sectionId);
                
                if (!container || !section) {
                    console.error('❌ 图表容器未找到');
                    return;
                }
                
                // 显示图表区域
                section.style.display = 'block';
                
                // 解析图表数据
                const data = JSON.parse(chartData);
                
                // 调整布局以确保完整显示
                if (data.layout) {
                    data.layout.height = 800; // 设置固定高度
                    data.layout.autosize = true;
                    data.layout.margin = {
                        l: 50,
                        r: 50,
                        t: 80,
                        b: 50
                    };
                }
                
                // 创建Plotly图表
                Plotly.newPlot(container, data.data, data.layout, {
                    responsive: true,
                    displayModeBar: true,
                    modeBarButtonsToRemove: ['pan2d', 'lasso2d', 'select2d'],
                    displaylogo: false,
                    autosize: true,
                    useResizeHandler: true
                }).then(function() {
                    console.log('✅ 图表显示成功');
                    
                    // 强制调整大小以确保完整显示
                    setTimeout(() => {
                        Plotly.Plots.resize(container);
                    }, 100);
                });
                
                // 添加窗口大小变化监听
                window.addEventListener('resize', function() {
                    Plotly.Plots.resize(container);
                });
                
            } catch (error) {
                console.error('❌ 图表显示失败:', error);
            }
        }

        // 相似度分析
        async function analyzeSimilarity() {
            console.log('🔍 开始相似度分析...');
            
            try {
                const formData = getFormData();
                showLoading();
                
                // 获取相似度分析参数
                const similarityParams = {
                    stock_code: formData.stockCode,
                    months: formData.months,
                    window_size: parseInt(document.getElementById('windowSize').value),
                    correlation_weight: parseInt(document.getElementById('correlationWeight').value),
                    trend_weight: parseInt(document.getElementById('trendWeight').value),
                    volatility_weight: parseInt(document.getElementById('volatilityWeight').value),
                    pattern_weight: parseInt(document.getElementById('patternWeight').value),
                    volume_weight: parseInt(document.getElementById('volumeWeight').value),
                    ma_window: parseInt(document.getElementById('maWindow').value),
                    move_day: parseInt(document.getElementById('moveDay').value),
                    data_missing: parseInt(document.getElementById('dataMissing').value)
                };
                
                console.log('相似度分析参数:', similarityParams);
                
                // 验证权重总和
                const totalWeight = similarityParams.correlation_weight + 
                                  similarityParams.trend_weight + 
                                  similarityParams.volatility_weight + 
                                  similarityParams.pattern_weight + 
                                  similarityParams.volume_weight;
                
                if (totalWeight !== 100) {
                    showError(`权重总和必须为100%，当前为${totalWeight}%`);
                    return;
                }
                
                const response = await fetch('/api/similarity_analysis', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(similarityParams)
                });

                const result = await response.json();
                console.log('相似度分析结果:', result);

                hideLoading();

                if (result.success) {
                    displaySimilarityResult(result);
                } else {
                    showError('相似度分析失败: ' + result.message);
                }
            } catch (error) {
                console.error('相似度分析错误:', error);
                hideLoading();
                showError('相似度分析失败: ' + error.message);
            }
        }

        // 显示相似度分析结果
        function displaySimilarityResult(result) {
            const similarityResult = getElementById('similarityResult');
            const similarityScore = getElementById('similarityScore');
            const dimensionScores = getElementById('dimensionScores');
            
            // 显示相似度分数
            const score = result.similarity_score || 0;
            const scoreClass = score >= 80 ? '' : score >= 60 ? 'medium' : 'low';
            
            similarityScore.innerHTML = `
                <div class="score-circle ${scoreClass}">
                    <div class="score-value">${score.toFixed(1)}</div>
                    <div class="score-label">综合相似度</div>
                </div>
            `;
            
            // 显示各维度分数
            const dimensions = result.dimension_scores || {};
            dimensionScores.innerHTML = `
                <div class="dimension-item">
                    <div class="score">${(dimensions.correlation || 0).toFixed(1)}</div>
                    <div class="label">价格相关性</div>
                </div>
                <div class="dimension-item">
                    <div class="score">${(dimensions.trend || 0).toFixed(1)}</div>
                    <div class="label">趋势一致性</div>
                </div>
                <div class="dimension-item">
                    <div class="score">${(dimensions.volatility || 0).toFixed(1)}</div>
                    <div class="label">波动性相似度</div>
                </div>
                <div class="dimension-item">
                    <div class="score">${(dimensions.pattern || 0).toFixed(1)}</div>
                    <div class="label">模式匹配</div>
                </div>
                <div class="dimension-item">
                    <div class="score">${(dimensions.volume || 0).toFixed(1)}</div>
                    <div class="label">成交量关系</div>
                </div>
            `;
            
            // 显示相似度图表
            if (result.chart_data) {
                displayChart(result.chart_data, 'similarityChartContainer', 'similarityChartSection');
            }
            
            similarityResult.style.display = 'block';
        }

        // 执行策略
        async function executeStrategy() {
            console.log('🚀 开始执行策略...');
            
            try {
                const formData = getFormData();
                const strategyParams = {
                    base_investment: formData.baseInvestment,
                    stop_loss_rate: formData.stopLossRate / 100, // 转换为小数
                    max_profit_rate: formData.maxProfitRate / 100, // 转换为小数
                    profit_callback_rate: formData.profitCallbackRate / 100, // 转换为小数
                    stock_code: formData.stockCode,
                    strategy_mode: formData.strategyMode,
                    min_gold_change: formData.minGoldChange / 100, // 转换为小数
                    min_buy_amount: formData.minBuyAmount,
                    transaction_cost_rate: formData.transactionCostRate / 100, // 转换为小数
                    max_hold_days: formData.maxHoldDays
                };
                
                console.log('策略参数:', strategyParams);
                showLoading();
                
                const response = await fetch('/api/execute_strategy', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(strategyParams)
                });

                const result = await response.json();
                console.log('策略执行结果:', result);

                hideLoading();
                    
                if (result.success) {
                    displayStrategyResult(result);
                } else {
                    showError('策略执行失败: ' + result.error);
                }
            } catch (error) {
                console.error('策略执行错误:', error);
                hideLoading();
                showError('策略执行失败: ' + error.message);
            }
        }
        
        // 显示策略执行结果
        function displayStrategyResult(result) {
            const strategyResult = getElementById('strategyResult');
            const strategyStats = getElementById('strategyStats');
            
            const summary = result.strategy_summary || {};
            
            strategyStats.innerHTML = `
                <div class="stat-card">
                    <div class="value">${summary.total_trades || 0}</div>
                    <div class="label">总交易次数</div>
                </div>
                <div class="stat-card">
                    <div class="value">¥${(summary.total_profit || 0).toFixed(2)}</div>
                    <div class="label">总盈利</div>
                </div>
                <div class="stat-card">
                    <div class="value">${summary.win_trades || 0}次</div>
                    <div class="label">盈利交易</div>
                </div>
                <div class="stat-card">
                    <div class="value">${(summary.win_rate || 0).toFixed(2)}%</div>
                    <div class="label">胜率</div>
                </div>
            `;
            
            strategyResult.style.display = 'block';
        }

        // 历史回测
        async function runBacktest() {
            console.log('📊 开始历史回测...');
            
            try {
                const formData = getFormData();
                const backtestParams = {
                    stock_code: formData.stockCode,
                    months: formData.backtestMonths, // 使用回测时间范围
                    base_investment: formData.baseInvestment,
                    stop_loss_rate: formData.stopLossRate / 100, // 转换为小数
                    max_profit_rate: formData.maxProfitRate / 100, // 转换为小数
                    profit_callback_rate: formData.profitCallbackRate / 100, // 转换为小数
                    min_gold_change: formData.minGoldChange / 100, // 转换为小数
                    min_buy_amount: formData.minBuyAmount,
                    transaction_cost_rate: formData.transactionCostRate / 100, // 转换为小数
                    max_hold_days: formData.maxHoldDays,
                    user_id: 100001,
                    auth: 'default_user'
                };
                
                console.log('回测参数:', backtestParams);
                showLoading();
                
                const response = await fetch('/api/backtest', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(backtestParams)
                });

                const result = await response.json();
                console.log('回测结果:', result);

                hideLoading();
                    
                if (result.success) {
                    displayBacktestResult(result.backtest_result);
                } else {
                    showError('回测失败: ' + result.error);
                }
            } catch (error) {
                console.error('回测错误:', error);
                hideLoading();
                showError('回测失败: ' + error.message);
            }
        }
        
        // 显示回测结果
        function displayBacktestResult(backtestResult) {
            const strategyResult = getElementById('strategyResult');
            const strategyStats = getElementById('strategyStats');
            
            const stats = backtestResult.statistics || {};
            const period = backtestResult.backtest_period || {};
            
            // 显示回测统计信息
            strategyStats.innerHTML = `
                <div class="stat-card">
                    <div class="value">${period.days || 0}</div>
                    <div class="label">回测天数</div>
                </div>
                <div class="stat-card">
                    <div class="value">${stats.total_trades || 0}</div>
                    <div class="label">总交易次数</div>
                </div>
                <div class="stat-card">
                    <div class="value">¥${(stats.total_net_profit || 0).toFixed(2)}</div>
                    <div class="label">总盈利</div>
                </div>
                <div class="stat-card">
                    <div class="value">${stats.win_trades || 0}次</div>
                    <div class="label">盈利交易</div>
                </div>
                <div class="stat-card">
                    <div class="value">${(stats.win_rate || 0).toFixed(2)}%</div>
                    <div class="label">胜率</div>
                </div>
                <div class="stat-card">
                    <div class="value">${(stats.annual_return || 0).toFixed(2)}%</div>
                    <div class="label">年化收益率</div>
                </div>
                <div class="stat-card">
                    <div class="value">${(stats.max_drawdown || 0).toFixed(2)}%</div>
                    <div class="label">最大回撤</div>
                </div>
                <div class="stat-card">
                    <div class="value">¥${(stats.final_market_value || 0).toFixed(2)}</div>
                    <div class="label">最终资产</div>
                </div>
            `;
            
            // 显示回测图表
            if (backtestResult.chart_data) {
                displayChart(backtestResult.chart_data, 'strategyChartContainer', 'strategyChartSection');
            }
            
            strategyResult.style.display = 'block';
            
            // 显示成功消息
            showSuccess(`历史回测完成！回测期间：${period.start_date} 至 ${period.end_date}`);
        }

        // 刷新数据
        async function refreshData() {
            console.log('🔄 刷新数据...');
            try {
                const formData = getFormData();
                console.log('🔍 刷新时的股票代码:', formData.stockCode);
                if (!formData.stockCode) {
                    console.log('未选择股票，跳过刷新');
                    return;
                }
                
                const response = await fetch(`/api/current_status?stock_code=${formData.stockCode}`);
                const status = await response.json();
                
                if (status.error) {
                    console.error('获取状态失败:', status.error);
                    return;
                }
                
                // 更新基础信息显示
                const basicInfoDisplay = getElementById('basicInfoDisplay');
                if (basicInfoDisplay && basicInfoDisplay.style.display !== 'none') {
                    // 直接使用获取到的状态数据，避免重复请求
                    await displayBasicInfoWithStatus(status);
                }
                
                console.log('✅ 数据刷新完成');
            } catch (error) {
                console.error('❌ 数据刷新失败:', error);
            }
        }

        // 显示错误信息
        function showError(message) {
            console.error('❌', message);
            // 这里可以添加错误提示UI
            alert('错误: ' + message);
        }

        // 显示成功信息
        function showSuccess(message) {
            console.log('✅', message);
            // 这里可以添加成功提示UI
            alert('成功: ' + message);
        }

        // 更新权重总和显示
        function updateWeightTotal() {
            const correlation = parseInt(document.getElementById('correlationWeight').value) || 0;
            const trend = parseInt(document.getElementById('trendWeight').value) || 0;
            const volatility = parseInt(document.getElementById('volatilityWeight').value) || 0;
            const pattern = parseInt(document.getElementById('patternWeight').value) || 0;
            const volume = parseInt(document.getElementById('volumeWeight').value) || 0;
            
            const total = correlation + trend + volatility + pattern + volume;
            
            const weightTotalElement = document.getElementById('weightTotal');
            const weightStatusElement = document.getElementById('weightStatus');
            
            if (weightTotalElement) {
                weightTotalElement.textContent = total;
            }
            
            if (weightStatusElement) {
                if (total === 100) {
                    weightStatusElement.textContent = '✓ 权重配置正确';
                    weightStatusElement.className = 'weight-status-ok';
                } else {
                    weightStatusElement.textContent = `✗ 权重总和应为100%`;
                    weightStatusElement.className = 'weight-status-error';
                }
            }
        }

        // 公共的API请求函数
        async function makeApiRequest(url, options = {}) {
            try {
                const response = await fetch(url, {
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    },
                    ...options
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                return await response.json();
            } catch (error) {
                console.error('API请求失败:', error);
                throw error;
            }
        }

        // 页面卸载时清理定时器
        window.addEventListener('beforeunload', function() {
            stopAutoRefresh();
        });
    </script>
</body>
</html>
