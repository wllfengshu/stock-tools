<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é»„é‡‘æ¿å—é‡åŒ–äº¤æ˜“ç³»ç»Ÿ</title>
    <script src="./plotly.min.js" onload="console.log('âœ… plotly.min.js è„šæœ¬åŠ è½½å®Œæˆ')" onerror="console.error('âŒ plotly.min.js è„šæœ¬åŠ è½½å¤±è´¥')">
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #ff6b6b, #ffa500);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .main-content {
            padding: 40px;
        }

        /* æ¨¡å—æ ·å¼ */
        .module {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            border: 2px solid #e9ecef;
        }

        .module h2 {
            color: #333;
            margin-bottom: 25px;
            font-size: 1.5em;
            border-bottom: 3px solid #ff6b6b;
            padding-bottom: 10px;
        }

        /* åŸºç¡€ä¿¡æ¯æ¨¡å—æ ·å¼ */
        .basic-info {
            background: linear-gradient(135deg, #e3f2fd, #f3e5f5);
        }

        .basic-info h2 {
            border-bottom-color: #2196f3;
        }

        /* ç›¸ä¼¼åº¦åˆ†ææ¨¡å—æ ·å¼ */
        .similarity-analysis {
            background: linear-gradient(135deg, #e8f5e8, #f1f8e9);
        }

        .similarity-analysis h2 {
            border-bottom-color: #4caf50;
        }

        /* æƒé‡é…ç½®æ ·å¼ */
        .weight-config {
            background: rgba(255, 255, 255, 0.7);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border: 2px solid #4caf50;
        }

        .weight-config h3 {
            color: #2e7d32;
            margin-bottom: 15px;
            font-size: 1.3em;
            text-align: center;
        }

        .weight-total {
            text-align: center;
            margin-top: 15px;
            padding: 10px;
            background: rgba(76, 175, 80, 0.1);
            border-radius: 5px;
            border: 1px solid #4caf50;
        }

        .weight-status-ok {
            color: #4caf50;
            margin-left: 10px;
        }

        .weight-status-error {
            color: #f44336;
            margin-left: 10px;
        }

        /* äº¤æ˜“ç­–ç•¥å‚æ•°æ ·å¼ */
        .strategy-info {
            padding: 8px 12px;
            background: rgba(255, 193, 7, 0.1);
            border-radius: 5px;
            border: 1px solid #ffc107;
        }

        .strategy-info small {
            color: #856404;
            font-style: italic;
        }

        .parameter-description {
            font-size: 0.9em;
            color: #666;
            margin-top: 4px;
            font-style: italic;
        }

        /* äº¤æ˜“ç­–ç•¥æ¨¡å—æ ·å¼ */
        .trading-strategy {
            background: linear-gradient(135deg, #fff3e0, #fce4ec);
        }

        .trading-strategy h2 {
            border-bottom-color: #ff9800;
        }

        /* è¡¨å•æ ·å¼ */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-weight: bold;
            margin-bottom: 8px;
            color: #333;
            font-size: 1.1em;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        select, input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        select:focus, input:focus {
            outline: none;
            border-color: #ff6b6b;
            box-shadow: 0 0 0 3px rgba(255, 107, 107, 0.1);
        }

        /* æŒ‰é’®æ ·å¼ */
        .btn {
            background: linear-gradient(135deg, #ff6b6b, #ffa500);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin: 5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(255, 107, 107, 0.3);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-similarity {
            background: linear-gradient(135deg, #667eea, #764ba2);
        }

        .btn-strategy {
            background: linear-gradient(135deg, #ff9800, #f57c00);
        }

        /* æ•°æ®å±•ç¤ºåŒºåŸŸ */
        .data-display {
            background: white;
            border-radius: 10px;
            padding: 25px;
            margin-top: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .data-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .data-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #ff6b6b;
            text-align: center;
        }

        .data-item .label {
            font-weight: bold;
            color: #666;
            font-size: 0.9em;
            margin-bottom: 5px;
        }

        .data-item .value {
            font-size: 1.2em;
            color: #333;
            font-weight: bold;
        }

        .data-item.positive .value {
            color: #dc3545;
        }

        .data-item.negative .value {
            color: #28a745;
        }

        /* å›¾è¡¨å®¹å™¨ */
        .chart-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
            width: 100%;
            min-height: 800px; /* å¢åŠ é«˜åº¦ä»¥æ˜¾ç¤ºå®Œæ•´çš„Kçº¿å›¾ */
        }

        #chartContainer, #similarityChartContainer {
            width: 100% !important;
            min-width: 100%;
            height: 800px !important; /* å›ºå®šé«˜åº¦ç¡®ä¿å®Œæ•´æ˜¾ç¤º */
        }

        /* ç›¸ä¼¼åº¦åˆ†æç»“æœ */
        .similarity-result {
            background: white;
            border-radius: 10px;
            padding: 25px;
            margin-top: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .similarity-score {
            text-align: center;
            margin-bottom: 30px;
        }

        .score-circle {
            display: inline-block;
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: linear-gradient(135deg, #4caf50, #8bc34a);
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            margin: 0 auto 20px;
            box-shadow: 0 10px 30px rgba(76, 175, 80, 0.3);
        }

        .score-circle.low {
            background: linear-gradient(135deg, #f44336, #ff5722);
        }

        .score-circle.medium {
            background: linear-gradient(135deg, #ff9800, #ffc107);
        }

        .score-value {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .score-label {
            font-size: 1em;
            opacity: 0.9;
        }

        .dimension-scores {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .dimension-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border-left: 4px solid #007bff;
        }

        .dimension-item .score {
            font-size: 1.5em;
            font-weight: bold;
            color: #007bff;
            margin-bottom: 5px;
        }

        .dimension-item .label {
            font-size: 0.9em;
            color: #666;
        }

        /* ç­–ç•¥æ‰§è¡Œç»“æœ */
        .strategy-result {
            background: white;
            border-radius: 10px;
            padding: 25px;
            margin-top: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .strategy-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            border-left: 4px solid #ff6b6b;
        }

        .stat-card .value {
            font-size: 2em;
            font-weight: bold;
            color: #ff6b6b;
            margin-bottom: 5px;
        }

        .stat-card .label {
            color: #666;
            font-size: 0.9em;
        }

        /* åŠ è½½çŠ¶æ€ */
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #ff6b6b;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* é”™è¯¯å’ŒæˆåŠŸæ¶ˆæ¯ */
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #f5c6cb;
            margin-top: 15px;
        }

        .success {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #c3e6cb;
            margin-top: 15px;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .main-content {
                padding: 20px;
            }

            .data-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            }
        }

        /* éšè—å…ƒç´  */
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ† é»„é‡‘æ¿å—é‡åŒ–äº¤æ˜“ç³»ç»Ÿ</h1>
            <p>åŸºäºä¼¦æ•¦é‡‘ä»·æ¶¨è·Œçš„æ™ºèƒ½äº¤æ˜“ç­–ç•¥åˆ†æå¹³å°</p>
        </div>

        <div class="main-content">
            <!-- åŸºç¡€ä¿¡æ¯æ¨¡å— -->
            <div class="module basic-info">
                <h2>ğŸ“Š åŸºç¡€ä¿¡æ¯æ¨¡å—</h2>
                
                <!-- å‚æ•°é…ç½® -->
                    <div class="form-row">
                        <div class="form-group">
                        <label for="stockSelect">é€‰æ‹©è‚¡ç¥¨</label>
                            <select id="stockSelect" name="stock_code">
                                <option value="">æ­£åœ¨åŠ è½½è‚¡ç¥¨åˆ—è¡¨...</option>
                            </select>
                            <div class="parameter-description">é€‰æ‹©ä¸€åªè‚¡ç¥¨</div>
                        </div>
                        <div class="form-group">
                            <label for="analysisMonths">åˆ†ææ—¶é—´èŒƒå›´</label>
                            <select id="analysisMonths" name="analysis_months">
                                <option value="1">1ä¸ªæœˆ</option>
                                <option value="2">2ä¸ªæœˆ</option>
                                <option value="3">3ä¸ªæœˆ</option>
                                <option value="6" selected>6ä¸ªæœˆ</option>
                                <option value="12">12ä¸ªæœˆ</option>
                                <option value="24">24ä¸ªæœˆ</option>
                            </select>
                            <div class="parameter-description">é€‰æ‹©åˆ†æçš„æ—¶é—´èŒƒå›´</div>
                        </div>
                        <div class="form-group">
                            <label for="initInvestment">åˆå§‹èµ„é‡‘ (å…ƒ)</label>
                            <input type="number" id="initInvestment" name="init_investment" value="10000" min="1000" step="1000">
                            <div class="parameter-description">å»ºä»“çš„é‡‘é¢</div>
                        </div>
                    </div>
                    
                <!-- æ“ä½œæŒ‰é’® -->
                <div style="text-align: center; margin: 20px 0;">
                    <button type="button" class="btn" id="analyzeBtn" onclick="analyzeStock()">
                        ğŸ“ˆ æŸ¥çœ‹åŸºç¡€ä¿¡æ¯
                    </button>
                </div>

                <!-- å®æ—¶æ•°æ®å±•ç¤º -->
                <div class="data-display" id="basicInfoDisplay" style="display: none;">
                    <h3>ğŸ“ˆ å®æ—¶æ•°æ®</h3>
                    <div class="data-grid" id="basicInfoGrid">
                        <!-- æ•°æ®å°†é€šè¿‡JavaScriptåŠ¨æ€å¡«å…… -->
                    </div>
                </div>

                <!-- Kçº¿å›¾å±•ç¤º -->
                <div class="chart-container" id="chartSection" style="display: none;">
                    <div id="chartContainer" style="width: 100%; height: 600px;">
                        <!-- Plotlyå›¾è¡¨å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                    </div>
                </div>
            </div>

            <!-- ç›¸ä¼¼åº¦åˆ†ææ¨¡å— -->
            <div class="module similarity-analysis">
                <h2>ğŸ” ç›¸ä¼¼åº¦åˆ†ææ¨¡å—</h2>
                
                <!-- åŸºç¡€å‚æ•°é…ç½® -->
                <div class="form-row">
                    <div class="form-group">
                        <label for="windowSize">æ»‘åŠ¨çª—å£å¤§å°</label>
                        <select id="windowSize" name="window_size">
                            <option value="2" selected>2å¤©</option>
                            <option value="3">3å¤©</option>
                            <option value="5">5å¤©</option>
                            <option value="7">7å¤©</option>
                            <option value="10">10å¤©</option>
                            <option value="15">20å¤©</option>
                        </select>
                        <div class="parameter-description">å°†æ—¶é—´åºåˆ—æ•°æ®åˆ†å‰²æˆå›ºå®šå¤§å°çš„çª—å£ï¼Œåœ¨æ¯ä¸ªçª—å£å†…è®¡ç®—ç›¸ä¼¼åº¦ï¼Œçª—å£è¶Šå°è¶Šæ•æ„Ÿ</div>
                    </div>
                    <div class="form-group">
                        <label for="maWindow">ç§»åŠ¨å¹³å‡çº¿çª—å£</label>
                        <select id="maWindow" name="ma_window">
                            <option value="5" selected>MA5</option>
                            <option value="10">MA10</option>
                            <option value="20">MA20</option>
                        </select>
                        <div class="parameter-description">è®¡ç®—å¤šæ¡ç§»åŠ¨å¹³å‡çº¿ï¼ˆMA5ã€MA10ã€MA20ï¼‰çš„ç›¸ä¼¼åº¦ï¼Œç”¨äºè¶‹åŠ¿åˆ†æ</div>
                    </div>
                    <div class="form-group">
                        <label for="moveDay">å¹³ç§»å¤©æ•°</label>
                        <input type="number" id="moveDay" name="move_day" value="1" min="-3" max="3" step="1">
                        <div class="parameter-description">ä¼¦æ•¦é‡‘ä»·é€šå¸¸é¢†å…ˆå›½å†…è‚¡å¸‚ï¼Œæ­£æ•°è¡¨ç¤ºç”¨å‰å‡ å¤©çš„é‡‘ä»·æ•°æ®ï¼Œè´Ÿæ•°è¡¨ç¤ºç”¨åå‡ å¤©çš„é‡‘ä»·æ•°æ®</div>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="dataMissing">æ•°æ®ç¼ºå¤±å¤„ç†</label>
                        <select id="dataMissing" name="data_missing">
                            <option value="0">ä¸å¤„ç†</option>
                            <option value="1" selected>è·³è¿‡</option>
                            <option value="2">ç”¨å‰ä¸€å¤©æ•°æ®å¡«å……</option>
                        </select>
                        <div class="parameter-description">å¤„ç†ä¼¦æ•¦é‡‘ä»·å’ŒAè‚¡äº¤æ˜“æ—¥ä¸åŒ¹é…çš„é—®é¢˜ï¼Œè·³è¿‡ç¼ºå¤±æ•°æ®æˆ–ä½¿ç”¨å‰å‘å¡«å……</div>
                    </div>
                </div>

                <!-- æƒé‡é…ç½®å‚æ•° -->
                <div class="weight-config">
                    <h3>ğŸ“Š ç›¸ä¼¼åº¦æƒé‡é…ç½®</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="correlationWeight">ä»·æ ¼å˜åŒ–ç›¸å…³æ€§æƒé‡ (%)</label>
                            <input type="number" id="correlationWeight" name="correlation_weight" value="30" min="0" max="100" step="5" onchange="updateWeightTotal()">
                            <div class="parameter-description">è®¡ç®—é‡‘ä»·å’Œè‚¡ä»·æ—¥æ¶¨è·Œå¹…çš„çš®å°”é€Šç›¸å…³ç³»æ•°ï¼Œè¡¡é‡ä»·æ ¼å˜åŒ–çš„åŒæ­¥æ€§</div>
                        </div>

                        <div class="form-group">
                            <label for="trendWeight">è¶‹åŠ¿æ–¹å‘ä¸€è‡´æ€§æƒé‡ (%)</label>
                            <input type="number" id="trendWeight" name="trend_weight" value="25" min="0" max="100" step="5" onchange="updateWeightTotal()">
                            <div class="parameter-description">æ¯”è¾ƒç§»åŠ¨å¹³å‡çº¿çš„æ–œç‡æ–¹å‘ï¼Œè¡¡é‡é‡‘ä»·å’Œè‚¡ä»·è¶‹åŠ¿çš„ä¸€è‡´æ€§</div>
                        </div>

                        <div class="form-group">
                            <label for="volatilityWeight">æ³¢åŠ¨æ€§ç›¸ä¼¼åº¦æƒé‡ (%)</label>
                            <input type="number" id="volatilityWeight" name="volatility_weight" value="20" min="0" max="100" step="5" onchange="updateWeightTotal()">
                            <div class="parameter-description">æ¯”è¾ƒä»·æ ¼æ³¢åŠ¨å¹…åº¦å’Œé¢‘ç‡ï¼Œè¡¡é‡é‡‘ä»·å’Œè‚¡ä»·æ³¢åŠ¨æ€§çš„ç›¸ä¼¼ç¨‹åº¦</div>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="patternWeight">ä»·æ ¼æ¨¡å¼åŒ¹é…æƒé‡ (%)</label>
                            <input type="number" id="patternWeight" name="pattern_weight" value="15" min="0" max="100" step="5" onchange="updateWeightTotal()">
                            <div class="parameter-description">ä½¿ç”¨DTWç®—æ³•è®¡ç®—ä»·æ ¼åºåˆ—ç›¸ä¼¼åº¦ï¼Œè¯†åˆ«é‡‘ä»·å’Œè‚¡ä»·çš„ä»·æ ¼æ¨¡å¼åŒ¹é…ç¨‹åº¦</div>
                        </div>

                        <div class="form-group">
                            <label for="volumeWeight">æˆäº¤é‡å…³ç³»æƒé‡ (%)</label>
                            <input type="number" id="volumeWeight" name="volume_weight" value="10" min="0" max="100" step="5" onchange="updateWeightTotal()">
                            <div class="parameter-description">åˆ†ææˆäº¤é‡ä¸ä»·æ ¼å˜åŒ–çš„å…³ç³»ç›¸ä¼¼åº¦ï¼Œè¡¡é‡é‡‘ä»·å’Œè‚¡ä»·çš„é‡ä»·å…³ç³»ä¸€è‡´æ€§</div>
                        </div>
                    </div>
                    
                    <!-- æƒé‡æ€»å’Œæ˜¾ç¤º -->
                    <div class="weight-total">
                        <strong>æƒé‡æ€»å’Œ: <span id="weightTotal">100</span>%</strong>
                        <span id="weightStatus" class="weight-status-ok">âœ“ æƒé‡é…ç½®æ­£ç¡®</span>
                    </div>
                </div>
                
                <div style="text-align: center; margin: 20px 0;">
                    <button type="button" class="btn btn-similarity" onclick="analyzeSimilarity()">
                        ğŸ” èµ°åŠ¿ç›¸ä¼¼åº¦åˆ†æ
                    </button>
                </div>

                <!-- ç›¸ä¼¼åº¦åˆ†æç»“æœ -->
                <div class="similarity-result" id="similarityResult" style="display: none;">
                    <h3>ğŸ“Š ç›¸ä¼¼åº¦åˆ†æç»“æœ</h3>
                    <div class="similarity-score" id="similarityScore">
                        <!-- ç›¸ä¼¼åº¦åˆ†æ•°å°†é€šè¿‡JavaScriptåŠ¨æ€å¡«å…… -->
                    </div>
                    <div class="dimension-scores" id="dimensionScores">
                        <!-- å„ç»´åº¦åˆ†æ•°å°†é€šè¿‡JavaScriptåŠ¨æ€å¡«å…… -->
                    </div>
                </div>

                <!-- ç›¸ä¼¼åº¦å›¾è¡¨ -->
                <div class="chart-container" id="similarityChartSection" style="display: none;">
                    <div id="similarityChartContainer" style="width: 100%; height: 600px;">
                        <!-- ç›¸ä¼¼åº¦åˆ†æå›¾è¡¨å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                    </div>
                </div>
            </div>

            <!-- äº¤æ˜“ç­–ç•¥æ‰§è¡Œæ¨¡å— -->
            <div class="module trading-strategy">
                <h2>ğŸš€ äº¤æ˜“ç­–ç•¥æ‰§è¡Œæ¨¡å—</h2>
                
                <!-- ç­–ç•¥å‚æ•°é…ç½® -->
                    <div class="form-row">
                        <div class="form-group">
                        <label for="baseInvestment">åŸºç¡€æŠ•èµ„é‡‘é¢ (å…ƒ)</label>
                        <input type="number" id="baseInvestment" name="base_investment" value="10000" min="100" step="100">
                        <div class="parameter-description">æ¯æ¬¡ä¹°å…¥é‡‘é¢ = åŸºç¡€é‡‘é¢ Ã— é‡‘ä»·æ¶¨å¹…</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="stopLossRate">æ­¢æŸç‡ (%)</label>
                            <input type="number" id="stopLossRate" name="stop_loss_rate" value="10" min="1" max="50" step="1">
                        <div class="parameter-description">å½“äºæŸè¾¾åˆ°æ­¤æ¯”ä¾‹æ—¶è‡ªåŠ¨å–å‡º</div>
                        </div>
                        
                        <div class="form-group">
                        <label for="maxProfitRate">æœ€å¤§ç›ˆåˆ©ç‡ (%)</label>
                            <input type="number" id="maxProfitRate" name="max_profit_rate" value="50" min="1" max="100" step="1">
                        <div class="parameter-description">å½“ç›ˆåˆ©è¶…è¿‡æ­¤æ¯”ä¾‹æ—¶è€ƒè™‘å–å‡º</div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="profitCallbackRate">ç›ˆåˆ©å›è°ƒç‡ (%)</label>
                                <input type="number" id="profitCallbackRate" name="profit_callback_rate" value="1" min="0.1" max="5" step="0.1">
                            <div class="parameter-description">ä»æœ€å¤§ç›ˆåˆ©å›è°ƒåˆ°æ­¤æ¯”ä¾‹æ—¶å–å‡º</div>
                        </div>
                        <div class="form-group">
                        <label for="minGoldChange">æœ€å°é‡‘ä»·æ¶¨å¹…é˜ˆå€¼ (%)</label>
                            <input type="number" id="minGoldChange" name="min_gold_change" value="0.2" min="0.1" max="10" step="0.1">
                        <div class="parameter-description">åªæœ‰é‡‘ä»·æ¶¨å¹…è¶…è¿‡æ­¤é˜ˆå€¼æ—¶æ‰ä¹°å…¥</div>
                        </div>
                        
                        <div class="form-group">
                        <label for="minBuyAmount">æœ€å°ä¹°å…¥é‡‘é¢ (å…ƒ)</label>
                            <input type="number" id="minBuyAmount" name="min_buy_amount" value="100" min="100" max="10000" step="100">
                        <div class="parameter-description">æ¯æ¬¡ä¹°å…¥é‡‘é¢ä¸èƒ½å°äºæ­¤å€¼</div>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                        <label for="transactionCostRate">äº¤æ˜“æˆæœ¬ç‡ (%)</label>
                            <input type="number" id="transactionCostRate" name="transaction_cost_rate" value="0.1" min="0.01" max="1" step="0.01">
                        <div class="parameter-description">æ¯æ¬¡ä¹°å…¥å’Œå–å‡ºçš„æ‰‹ç»­è´¹æ¯”ä¾‹</div>
                        </div>
                        
                        <div class="form-group">
                        <label for="maxHoldDays">æœ€å¤§æŒä»“å¤©æ•°</label>
                            <input type="number" id="maxHoldDays" name="max_hold_days" value="30" min="1" max="365" step="1">
                        <div class="parameter-description">è¶…è¿‡æ­¤å¤©æ•°æ—¶å¼ºåˆ¶å–å‡º</div>
                        </div>

                        <div class="form-group">
                        <label for="strategyMode">ç­–ç•¥æ¨¡å¼</label>
                            <select id="strategyMode" name="strategy_mode">
                                <option value="basic">åŸºç¡€æ¨¡å¼</option>
                                <option value="improved" selected>æ”¹è¿›æ¨¡å¼</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- å›æµ‹æ—¶é—´èŒƒå›´é€‰æ‹© -->
                    <div class="form-row">
                        <div class="form-group">
                            <label for="backtestMonths">å›æµ‹æ—¶é—´èŒƒå›´</label>
                            <select id="backtestMonths" name="backtest_months">
                                <option value="1">1ä¸ªæœˆ</option>
                                <option value="3">3ä¸ªæœˆ</option>
                                <option value="6" selected>6ä¸ªæœˆ</option>
                                <option value="12">12ä¸ªæœˆ</option>
                                <option value="24">24ä¸ªæœˆ</option>
                            </select>
                            <div class="parameter-description">é€‰æ‹©å†å²å›æµ‹çš„æ—¶é—´èŒƒå›´</div>
                        </div>
                    </div>
                    
                <!-- æ“ä½œæŒ‰é’® -->
                <div style="text-align: center; margin: 20px 0;">
                    <button type="button" class="btn btn-strategy" onclick="executeStrategy()">
                        ğŸš€ æ‰§è¡Œç­–ç•¥
                    </button>
                    <button type="button" class="btn btn-strategy" onclick="runBacktest()">
                        ğŸ“Š å†å²å›æµ‹
                    </button>
            </div>

                <!-- ç­–ç•¥æ‰§è¡Œç»“æœ -->
                <div class="strategy-result" id="strategyResult" style="display: none;">
                    <h3>ğŸ“‹ ç­–ç•¥æ‰§è¡Œç»“æœ</h3>
                    <div class="strategy-stats" id="strategyStats">
                        <!-- ç­–ç•¥ç»Ÿè®¡å°†é€šè¿‡JavaScriptåŠ¨æ€å¡«å…… -->
                        </div>
                        </div>

                <!-- ç­–ç•¥å›¾è¡¨ -->
                <div class="chart-container" id="strategyChartSection" style="display: none;">
                    <div id="strategyChartContainer" style="width: 100%; height: 600px;">
                        <!-- ç­–ç•¥å›¾è¡¨å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                    </div>
                </div>
            </div>

            <!-- åŠ è½½çŠ¶æ€ -->
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>æ­£åœ¨å¤„ç†æ•°æ®ï¼Œè¯·ç¨å€™...</p>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let currentStatus = null;
        let statusUpdateInterval = null;
        let autoRefreshInterval = null;

        // DOMå…ƒç´ 
        let loading, analyzeBtn;

        // DOMå…ƒç´ è·å–å‡½æ•°
        function getElementById(id) {
            return document.getElementById(id);
        }

        // è·å–è¡¨å•æ•°æ®
        function getFormData() {
            return {
                stockCode: getElementById('stockSelect').value,
                months: parseInt(getElementById('analysisMonths').value),
                stockName: getElementById('stockSelect').selectedOptions[0].text,
                baseInvestment: parseFloat(getElementById('baseInvestment').value),
                stopLossRate: parseFloat(getElementById('stopLossRate').value),
                maxProfitRate: parseFloat(getElementById('maxProfitRate').value),
                profitCallbackRate: parseFloat(getElementById('profitCallbackRate').value),
                minGoldChange: parseFloat(getElementById('minGoldChange').value),
                minBuyAmount: parseFloat(getElementById('minBuyAmount').value),
                transactionCostRate: parseFloat(getElementById('transactionCostRate').value),
                maxHoldDays: parseInt(getElementById('maxHoldDays').value),
                strategyMode: getElementById('strategyMode').value,
                backtestMonths: parseInt(getElementById('backtestMonths').value)
            };
        }

        // åŠ è½½è‚¡ç¥¨åˆ—è¡¨
        async function loadStockList() {
            try {
                console.log('ğŸ”„ æ­£åœ¨åŠ è½½è‚¡ç¥¨åˆ—è¡¨...');
                const response = await makeApiRequest('/api/stock_list');
                
                if (response && Array.isArray(response)) {
                    const stockSelect = getElementById('stockSelect');
                    stockSelect.innerHTML = ''; // æ¸…ç©ºç°æœ‰é€‰é¡¹
                    
                    // æ·»åŠ é»˜è®¤é€‰é¡¹
                    const defaultOption = document.createElement('option');
                    defaultOption.value = '';
                    defaultOption.textContent = 'è¯·é€‰æ‹©è‚¡ç¥¨';
                    stockSelect.appendChild(defaultOption);
                    
                    // æ·»åŠ è‚¡ç¥¨é€‰é¡¹
                    response.forEach((stock, index) => {
                        const option = document.createElement('option');
                        option.value = stock.code;
                        option.textContent = `${stock.name} (${stock.code})`;
                        
                        // è®¾ç½®ç¬¬ä¸€ä¸ªè‚¡ç¥¨ä¸ºé»˜è®¤é€‰ä¸­
                        if (index === 0) {
                            option.selected = true;
                        }
                        
                        stockSelect.appendChild(option);
                    });
                    
                    console.log(`âœ… è‚¡ç¥¨åˆ—è¡¨åŠ è½½å®Œæˆï¼Œå…± ${response.length} åªè‚¡ç¥¨`);
                } else {
                    console.error('âŒ è‚¡ç¥¨åˆ—è¡¨æ•°æ®æ ¼å¼é”™è¯¯');
                    showError('è‚¡ç¥¨åˆ—è¡¨æ•°æ®æ ¼å¼é”™è¯¯');
                }
            } catch (error) {
                console.error('âŒ åŠ è½½è‚¡ç¥¨åˆ—è¡¨å¤±è´¥:', error);
                showError('åŠ è½½è‚¡ç¥¨åˆ—è¡¨å¤±è´¥: ' + error.message);
                
                // å¦‚æœåŠ è½½å¤±è´¥ï¼Œè®¾ç½®é»˜è®¤è‚¡ç¥¨
                const stockSelect = getElementById('stockSelect');
                stockSelect.innerHTML = `
                    <option value="002155" selected>æ¹–å—é»„é‡‘ (002155)</option>
                    <option value="600547">å±±ä¸œé»„é‡‘ (600547)</option>
                    <option value="000975">é“¶æ³°é»„é‡‘ (000975)</option>
                    <option value="600489">ä¸­é‡‘é»„é‡‘ (600489)</option>
                    <option value="002237">æ’é‚¦è‚¡ä»½ (002237)</option>
                    <option value="600988">èµ¤å³°é»„é‡‘ (600988)</option>
                `;
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸš€ é¡µé¢DOMåŠ è½½å®Œæˆ');
            
            // åˆå§‹åŒ–æƒé‡æ€»å’Œæ˜¾ç¤º
            updateWeightTotal();
            
            // åˆå§‹åŒ–DOMå…ƒç´ 
            loading = document.getElementById('loading');
            analyzeBtn = document.getElementById('analyzeBtn');
            
            console.log('DOMå…ƒç´ åˆå§‹åŒ–å®Œæˆ');
            
            // åŠ è½½è‚¡ç¥¨åˆ—è¡¨
            loadStockList().then(() => {
                console.log('âœ… è‚¡ç¥¨åˆ—è¡¨åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–é¡µé¢...');
                
                // å¼€å§‹è‡ªåŠ¨åˆ·æ–°
                startAutoRefresh();
                
                // ç«‹å³æ˜¾ç¤ºåŸºç¡€ä¿¡æ¯
                setTimeout(() => {
                    console.log('ğŸ”„ é¡µé¢åˆå§‹åŒ–ï¼Œæ˜¾ç¤ºåŸºç¡€ä¿¡æ¯...');
                    showRealtimeDataModule(); // å¼ºåˆ¶æ˜¾ç¤ºæ¨¡å—
                    displayBasicInfo(); // è°ƒç”¨ä¸å¸¦å‚æ•°çš„å‡½æ•°ï¼Œè®©å®ƒè‡ªå·±è·å–æ•°æ®
                }, 1000);
            }).catch((error) => {
                console.error('âŒ è‚¡ç¥¨åˆ—è¡¨åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤é…ç½®:', error);
                // å³ä½¿è‚¡ç¥¨åˆ—è¡¨åŠ è½½å¤±è´¥ï¼Œä¹Ÿç»§ç»­åˆå§‹åŒ–é¡µé¢
                startAutoRefresh();
                setTimeout(() => {
                    showRealtimeDataModule();
                    displayBasicInfo();
                }, 1000);
            });
            
            // æ·»åŠ è‚¡ç¥¨é€‰æ‹©å˜åŒ–ç›‘å¬å™¨
            const stockSelect = getElementById('stockSelect');
            stockSelect.addEventListener('change', function() {
                console.log('è‚¡ç¥¨é€‰æ‹©å˜åŒ–:', this.value);
                // å¼ºåˆ¶æ˜¾ç¤ºæ¨¡å—å¹¶åˆ·æ–°æ•°æ®
                showRealtimeDataModule();
                displayBasicInfo(); // è°ƒç”¨ä¸å¸¦å‚æ•°çš„å‡½æ•°ï¼Œè®©å®ƒè‡ªå·±è·å–æ•°æ®
            });
            
            // æ£€æŸ¥Plotlyåº“
            checkPlotlyLoaded();
        });

        // æ£€æŸ¥Plotlyåº“æ˜¯å¦åŠ è½½
        function checkPlotlyLoaded() {
            let checkCount = 0;
            const maxChecks = 10;
            
            function checkPlotly() {
                if (typeof Plotly !== 'undefined') {
                    console.log('âœ… Plotlyåº“æ£€æŸ¥æˆåŠŸ');
                    return;
                } else if (checkCount < maxChecks) {
                    checkCount++;
                    console.log(`â³ Plotlyåº“æœªå°±ç»ªï¼Œ${500}msåé‡è¯• (${checkCount}/${maxChecks})`);
                    setTimeout(checkPlotly, 500);
                } else {
                    console.error('âŒ Plotlyåº“åŠ è½½è¶…æ—¶');
                }
            }
            
            checkPlotly();
        }

        // å¼€å§‹è‡ªåŠ¨åˆ·æ–°
        function startAutoRefresh() {
            // æ¯10ç§’è‡ªåŠ¨åˆ·æ–°æ•°æ®
            autoRefreshInterval = setInterval(refreshData, 10000);
            console.log('ğŸ”„ è‡ªåŠ¨åˆ·æ–°å·²å¯åŠ¨ï¼Œæ¯10ç§’åˆ·æ–°ä¸€æ¬¡');
        }

        // åœæ­¢è‡ªåŠ¨åˆ·æ–°
        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
                console.log('â¹ï¸ è‡ªåŠ¨åˆ·æ–°å·²åœæ­¢');
            }
        }

        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        function showLoading() {
            if (loading) {
                loading.classList.add('show');
            }
            if (analyzeBtn) {
                analyzeBtn.disabled = true;
                analyzeBtn.textContent = 'åˆ†æä¸­...';
            }
        }

        // éšè—åŠ è½½çŠ¶æ€
        function hideLoading() {
            if (loading) {
                loading.classList.remove('show');
            }
            if (analyzeBtn) {
                analyzeBtn.disabled = false;
                analyzeBtn.textContent = 'ğŸ“ˆ å¼€å§‹åˆ†æ';
            }
        }

        // åˆ†æè‚¡ç¥¨æ•°æ®
        async function analyzeStock() {
            console.log('ğŸ” å¼€å§‹åˆ†æè‚¡ç¥¨æ•°æ®...');
            
            try {
                const formData = getFormData();
                const data = {
                    months: formData.months,
                    stock_code: formData.stockCode,
                    stock_name: formData.stockName
                };

                console.log('åˆ†æå‚æ•°:', data);
                showLoading();
                
                const response = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                console.log('åˆ†æç»“æœ:', result);

                hideLoading();

                if (result.success) {
                    // æ˜¾ç¤ºåŸºç¡€ä¿¡æ¯
                    displayBasicInfo(result);
                    
                    // æ˜¾ç¤ºKçº¿å›¾
                    if (result.chart_data) {
                        displayChart(result.chart_data, 'chartContainer', 'chartSection');
                    }
                } else {
                    showError('åˆ†æå¤±è´¥: ' + result.message);
                }
            } catch (error) {
                console.error('åˆ†æé”™è¯¯:', error);
                hideLoading();
                showError('åˆ†æå¤±è´¥: ' + error.message);
            }
        }

        // ç”ŸæˆåŸºç¡€ä¿¡æ¯HTMLå†…å®¹
        function generateBasicInfoHTML(status) {
            // è®¡ç®—æ€»èµ„äº§å’Œæ”¶ç›Šç‡
            const currentPrice = status.current_price || 0;
            const position = status.position || {};
            const totalShares = status.total_shares || 0;
            const totalAssets = status.total_assets || 0;  // å½“å‰å¸‚å€¼
            const totalCost = status.total_cost || 0;
            const profitLoss = totalAssets - totalCost;  // ç›ˆäºé‡‘é¢
            const todayReturn = status.stock_change_rate || 0;  // ä½¿ç”¨è‚¡ä»·æ¶¨è·Œå¹…ä½œä¸ºä»Šæ—¥æ”¶ç›Šç‡
            const cumulativeReturn = status.cumulative_return || 0;
            const annualReturn = status.annual_return || 0;
            
            return `
                <div class="data-item">
                    <div class="label">å½“å‰è‚¡ä»·</div>
                    <div class="value">Â¥${currentPrice.toFixed(2)}</div>
                </div>
                <div class="data-item ${todayReturn >= 0 ? 'positive' : 'negative'}">
                    <div class="label">è‚¡ä»·æ¶¨è·Œ</div>
                    <div class="value">${(todayReturn * 100).toFixed(2)}%</div>
                </div>
                <div class="data-item">
                    <div class="label">ä¼¦æ•¦é‡‘ä»·</div>
                    <div class="value">$${status.gold_price.toFixed(2)}</div>
                </div>
                <div class="data-item ${status.gold_change_rate >= 0 ? 'positive' : 'negative'}">
                    <div class="label">é‡‘ä»·æ¶¨è·Œ</div>
                    <div class="value">${(status.gold_change_rate * 100).toFixed(2)}%</div>
                </div>
                <div class="data-item">
                    <div class="label">æŠ•èµ„æˆæœ¬</div>
                    <div class="value">Â¥${totalCost.toLocaleString()}</div>
                </div>
                <div class="data-item">
                    <div class="label">æ€»æŒè‚¡æ•°</div>
                    <div class="value">${totalShares.toFixed(2)}è‚¡</div>
                </div>
                <div class="data-item">
                    <div class="label">æ€»èµ„äº§ï¼ˆå½“å‰å¸‚å€¼ï¼‰</div>
                    <div class="value">Â¥${totalAssets.toLocaleString()}</div>
                </div>
                <div class="data-item ${profitLoss >= 0 ? 'positive' : 'negative'}">
                    <div class="label">ç›ˆäºé‡‘é¢</div>
                    <div class="value">Â¥${profitLoss.toLocaleString()}</div>
                </div>
                <div class="data-item ${todayReturn >= 0 ? 'positive' : 'negative'}">
                    <div class="label">ä»Šæ—¥æ”¶ç›Šç‡</div>
                    <div class="value">${(todayReturn * 100).toFixed(2)}%</div>
                </div>
                <div class="data-item ${cumulativeReturn >= 0 ? 'positive' : 'negative'}">
                    <div class="label">ç´¯è®¡æ”¶ç›Šç‡</div>
                    <div class="value">${(cumulativeReturn * 100).toFixed(2)}%</div>
                </div>
                <div class="data-item ${annualReturn >= 0 ? 'positive' : 'negative'}">
                    <div class="label">å¹´åŒ–æ”¶ç›Šç‡</div>
                    <div class="value">${(annualReturn * 100).toFixed(2)}%</div>
                </div>
            `;
        }

        // æ˜¾ç¤ºåŸºç¡€ä¿¡æ¯ï¼ˆä½¿ç”¨ä¼ å…¥çš„çŠ¶æ€æ•°æ®ï¼‰
        async function displayBasicInfoWithStatus(status) {
            const basicInfoDisplay = getElementById('basicInfoDisplay');
            const basicInfoGrid = getElementById('basicInfoGrid');
            
            try {
                console.log('ä½¿ç”¨ä¼ å…¥çš„çŠ¶æ€æ•°æ®:', status);
                console.log('JSONæ•°æ®è°ƒè¯•:', {
                    total_cost: status.total_cost,
                    total_shares: status.total_shares,
                    cumulative_return: status.cumulative_return,
                    annual_return: status.annual_return
                });
                
                console.log('è‚¡ä»·æ•°æ®è°ƒè¯•:', {
                    currentPrice: status.current_price,
                    stockChangeRate: status.stock_change_rate,
                    goldPrice: status.gold_price,
                    goldChangeRate: status.gold_change_rate
                });
                
                basicInfoGrid.innerHTML = generateBasicInfoHTML(status);
                basicInfoDisplay.style.display = 'block';
            } catch (error) {
                console.error('æ˜¾ç¤ºåŸºç¡€ä¿¡æ¯å¤±è´¥:', error);
                showError('æ˜¾ç¤ºåŸºç¡€ä¿¡æ¯å¤±è´¥: ' + error.message);
            }
        }

        // å¼ºåˆ¶æ˜¾ç¤ºå®æ—¶æ•°æ®æ¨¡å—
        function showRealtimeDataModule() {
            const basicInfoDisplay = getElementById('basicInfoDisplay');
            if (basicInfoDisplay) {
                basicInfoDisplay.style.display = 'block';
                console.log('âœ… å¼ºåˆ¶æ˜¾ç¤ºå®æ—¶æ•°æ®æ¨¡å—');
            } else {
                console.error('âŒ æ‰¾ä¸åˆ°å®æ—¶æ•°æ®æ¨¡å—å…ƒç´ ');
            }
        }

        // æ˜¾ç¤ºåŸºç¡€ä¿¡æ¯
        async function displayBasicInfo(result) {
            console.log('ğŸ”„ å¼€å§‹æ˜¾ç¤ºåŸºç¡€ä¿¡æ¯...');
            const basicInfoDisplay = getElementById('basicInfoDisplay');
            const basicInfoGrid = getElementById('basicInfoGrid');
            
            console.log('ğŸ” DOMå…ƒç´ æ£€æŸ¥:', {
                basicInfoDisplay: basicInfoDisplay,
                basicInfoGrid: basicInfoGrid
            });
            
            console.log('ğŸ” è‚¡ç¥¨é€‰æ‹©å™¨æ£€æŸ¥:', {
                stockSelect: getElementById('stockSelect'),
                selectedValue: getElementById('stockSelect')?.value
            });
            
            try {
                // ä»APIè·å–çœŸå®çš„çŠ¶æ€æ•°æ®
                const formData = getFormData();
                console.log('ğŸ” å½“å‰é€‰æ‹©çš„è‚¡ç¥¨ä»£ç :', formData.stockCode);
                
                if (!formData.stockCode) {
                    console.error('âŒ è‚¡ç¥¨ä»£ç ä¸ºç©º');
                    showError('è¯·é€‰æ‹©è‚¡ç¥¨');
                    return;
                }

                console.log('ğŸ“¡ æ­£åœ¨è¯·æ±‚API...');
                const response = await fetch(`/api/current_status?stock_code=${formData.stockCode}`);
                console.log('ğŸ“¡ APIå“åº”çŠ¶æ€:', response.status);
                
                const status = await response.json();
                console.log('ğŸ“Š è·å–åˆ°çš„çŠ¶æ€æ•°æ®:', status);
                
                if (status.error) {
                    console.error('âŒ è·å–çŠ¶æ€å¤±è´¥:', status.error);
                    showError('è·å–å®æ—¶æ•°æ®å¤±è´¥: ' + status.error);
                    return;
                }
                
                console.log('ğŸ“Š è®¡ç®—åçš„æ•°æ®:', {
                    currentPrice: status.current_price,
                    stockChangeRate: status.stock_change_rate,
                    goldPrice: status.gold_price,
                    goldChangeRate: status.gold_change_rate,
                    totalShares: status.total_shares,
                    totalAssets: status.total_assets,
                    totalCost: status.total_cost,
                    cumulativeReturn: status.cumulative_return,
                    annualReturn: status.annual_return
                });
                
                console.log('ğŸ¨ å¼€å§‹ç”ŸæˆHTMLå†…å®¹...');
                basicInfoGrid.innerHTML = generateBasicInfoHTML(status);
                basicInfoDisplay.style.display = 'block';
                console.log('âœ… å®æ—¶æ•°æ®æ¨¡å—å·²æ˜¾ç¤º');
                console.log('ğŸ” æ¨¡å—å†…å®¹æ£€æŸ¥:', {
                    innerHTML: basicInfoGrid.innerHTML.substring(0, 100) + '...',
                    display: basicInfoDisplay.style.display,
                    visible: basicInfoDisplay.offsetHeight > 0
                });
            } catch (error) {
                console.error('è·å–åŸºç¡€ä¿¡æ¯å¤±è´¥:', error);
                showError('è·å–åŸºç¡€ä¿¡æ¯å¤±è´¥: ' + error.message);
            }
        }

        // æ˜¾ç¤ºå›¾è¡¨
        function displayChart(chartData, containerId, sectionId) {
            try {
                if (typeof Plotly === 'undefined') {
                    console.error('âŒ Plotlyåº“æœªåŠ è½½');
                return;
            }
            
                const container = getElementById(containerId);
                const section = getElementById(sectionId);
                
                if (!container || !section) {
                    console.error('âŒ å›¾è¡¨å®¹å™¨æœªæ‰¾åˆ°');
                    return;
                }
                
                // æ˜¾ç¤ºå›¾è¡¨åŒºåŸŸ
                section.style.display = 'block';
                
                // è§£æå›¾è¡¨æ•°æ®
                const data = JSON.parse(chartData);
                
                // è°ƒæ•´å¸ƒå±€ä»¥ç¡®ä¿å®Œæ•´æ˜¾ç¤º
                if (data.layout) {
                    data.layout.height = 800; // è®¾ç½®å›ºå®šé«˜åº¦
                    data.layout.autosize = true;
                    data.layout.margin = {
                        l: 50,
                        r: 50,
                        t: 80,
                        b: 50
                    };
                }
                
                // åˆ›å»ºPlotlyå›¾è¡¨
                Plotly.newPlot(container, data.data, data.layout, {
                    responsive: true,
                    displayModeBar: true,
                    modeBarButtonsToRemove: ['pan2d', 'lasso2d', 'select2d'],
                    displaylogo: false,
                    autosize: true,
                    useResizeHandler: true
                }).then(function() {
                    console.log('âœ… å›¾è¡¨æ˜¾ç¤ºæˆåŠŸ');
                    
                    // å¼ºåˆ¶è°ƒæ•´å¤§å°ä»¥ç¡®ä¿å®Œæ•´æ˜¾ç¤º
                    setTimeout(() => {
                        Plotly.Plots.resize(container);
                    }, 100);
                });
                
                // æ·»åŠ çª—å£å¤§å°å˜åŒ–ç›‘å¬
                window.addEventListener('resize', function() {
                    Plotly.Plots.resize(container);
                });
                
            } catch (error) {
                console.error('âŒ å›¾è¡¨æ˜¾ç¤ºå¤±è´¥:', error);
            }
        }

        // ç›¸ä¼¼åº¦åˆ†æ
        async function analyzeSimilarity() {
            console.log('ğŸ” å¼€å§‹ç›¸ä¼¼åº¦åˆ†æ...');
            
            try {
                const formData = getFormData();
                showLoading();
                
                // è·å–ç›¸ä¼¼åº¦åˆ†æå‚æ•°
                const similarityParams = {
                    stock_code: formData.stockCode,
                    months: formData.months,
                    window_size: parseInt(document.getElementById('windowSize').value),
                    correlation_weight: parseInt(document.getElementById('correlationWeight').value),
                    trend_weight: parseInt(document.getElementById('trendWeight').value),
                    volatility_weight: parseInt(document.getElementById('volatilityWeight').value),
                    pattern_weight: parseInt(document.getElementById('patternWeight').value),
                    volume_weight: parseInt(document.getElementById('volumeWeight').value),
                    ma_window: parseInt(document.getElementById('maWindow').value),
                    move_day: parseInt(document.getElementById('moveDay').value),
                    data_missing: parseInt(document.getElementById('dataMissing').value)
                };
                
                console.log('ç›¸ä¼¼åº¦åˆ†æå‚æ•°:', similarityParams);
                
                // éªŒè¯æƒé‡æ€»å’Œ
                const totalWeight = similarityParams.correlation_weight + 
                                  similarityParams.trend_weight + 
                                  similarityParams.volatility_weight + 
                                  similarityParams.pattern_weight + 
                                  similarityParams.volume_weight;
                
                if (totalWeight !== 100) {
                    showError(`æƒé‡æ€»å’Œå¿…é¡»ä¸º100%ï¼Œå½“å‰ä¸º${totalWeight}%`);
                    return;
                }
                
                const response = await fetch('/api/similarity_analysis', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(similarityParams)
                });

                const result = await response.json();
                console.log('ç›¸ä¼¼åº¦åˆ†æç»“æœ:', result);

                hideLoading();

                if (result.success) {
                    displaySimilarityResult(result);
                } else {
                    showError('ç›¸ä¼¼åº¦åˆ†æå¤±è´¥: ' + result.message);
                }
            } catch (error) {
                console.error('ç›¸ä¼¼åº¦åˆ†æé”™è¯¯:', error);
                hideLoading();
                showError('ç›¸ä¼¼åº¦åˆ†æå¤±è´¥: ' + error.message);
            }
        }

        // æ˜¾ç¤ºç›¸ä¼¼åº¦åˆ†æç»“æœ
        function displaySimilarityResult(result) {
            const similarityResult = getElementById('similarityResult');
            const similarityScore = getElementById('similarityScore');
            const dimensionScores = getElementById('dimensionScores');
            
            // æ˜¾ç¤ºç›¸ä¼¼åº¦åˆ†æ•°
            const score = result.similarity_score || 0;
            const scoreClass = score >= 80 ? '' : score >= 60 ? 'medium' : 'low';
            
            similarityScore.innerHTML = `
                <div class="score-circle ${scoreClass}">
                    <div class="score-value">${score.toFixed(1)}</div>
                    <div class="score-label">ç»¼åˆç›¸ä¼¼åº¦</div>
                </div>
            `;
            
            // æ˜¾ç¤ºå„ç»´åº¦åˆ†æ•°
            const dimensions = result.dimension_scores || {};
            dimensionScores.innerHTML = `
                <div class="dimension-item">
                    <div class="score">${(dimensions.correlation || 0).toFixed(1)}</div>
                    <div class="label">ä»·æ ¼ç›¸å…³æ€§</div>
                </div>
                <div class="dimension-item">
                    <div class="score">${(dimensions.trend || 0).toFixed(1)}</div>
                    <div class="label">è¶‹åŠ¿ä¸€è‡´æ€§</div>
                </div>
                <div class="dimension-item">
                    <div class="score">${(dimensions.volatility || 0).toFixed(1)}</div>
                    <div class="label">æ³¢åŠ¨æ€§ç›¸ä¼¼åº¦</div>
                </div>
                <div class="dimension-item">
                    <div class="score">${(dimensions.pattern || 0).toFixed(1)}</div>
                    <div class="label">æ¨¡å¼åŒ¹é…</div>
                </div>
                <div class="dimension-item">
                    <div class="score">${(dimensions.volume || 0).toFixed(1)}</div>
                    <div class="label">æˆäº¤é‡å…³ç³»</div>
                </div>
            `;
            
            // æ˜¾ç¤ºç›¸ä¼¼åº¦å›¾è¡¨
            if (result.chart_data) {
                displayChart(result.chart_data, 'similarityChartContainer', 'similarityChartSection');
            }
            
            similarityResult.style.display = 'block';
        }

        // æ‰§è¡Œç­–ç•¥
        async function executeStrategy() {
            console.log('ğŸš€ å¼€å§‹æ‰§è¡Œç­–ç•¥...');
            
            try {
                const formData = getFormData();
                const strategyParams = {
                    base_investment: formData.baseInvestment,
                    stop_loss_rate: formData.stopLossRate / 100, // è½¬æ¢ä¸ºå°æ•°
                    max_profit_rate: formData.maxProfitRate / 100, // è½¬æ¢ä¸ºå°æ•°
                    profit_callback_rate: formData.profitCallbackRate / 100, // è½¬æ¢ä¸ºå°æ•°
                    stock_code: formData.stockCode,
                    strategy_mode: formData.strategyMode,
                    min_gold_change: formData.minGoldChange / 100, // è½¬æ¢ä¸ºå°æ•°
                    min_buy_amount: formData.minBuyAmount,
                    transaction_cost_rate: formData.transactionCostRate / 100, // è½¬æ¢ä¸ºå°æ•°
                    max_hold_days: formData.maxHoldDays
                };
                
                console.log('ç­–ç•¥å‚æ•°:', strategyParams);
                showLoading();
                
                const response = await fetch('/api/execute_strategy', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(strategyParams)
                });

                const result = await response.json();
                console.log('ç­–ç•¥æ‰§è¡Œç»“æœ:', result);

                hideLoading();
                    
                if (result.success) {
                    displayStrategyResult(result);
                } else {
                    showError('ç­–ç•¥æ‰§è¡Œå¤±è´¥: ' + result.error);
                }
            } catch (error) {
                console.error('ç­–ç•¥æ‰§è¡Œé”™è¯¯:', error);
                hideLoading();
                showError('ç­–ç•¥æ‰§è¡Œå¤±è´¥: ' + error.message);
            }
        }
        
        // æ˜¾ç¤ºç­–ç•¥æ‰§è¡Œç»“æœ
        function displayStrategyResult(result) {
            const strategyResult = getElementById('strategyResult');
            const strategyStats = getElementById('strategyStats');
            
            const summary = result.strategy_summary || {};
            
            strategyStats.innerHTML = `
                <div class="stat-card">
                    <div class="value">${summary.total_trades || 0}</div>
                    <div class="label">æ€»äº¤æ˜“æ¬¡æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="value">Â¥${(summary.total_profit || 0).toFixed(2)}</div>
                    <div class="label">æ€»ç›ˆåˆ©</div>
                </div>
                <div class="stat-card">
                    <div class="value">${summary.win_trades || 0}æ¬¡</div>
                    <div class="label">ç›ˆåˆ©äº¤æ˜“</div>
                </div>
                <div class="stat-card">
                    <div class="value">${(summary.win_rate || 0).toFixed(2)}%</div>
                    <div class="label">èƒœç‡</div>
                </div>
            `;
            
            strategyResult.style.display = 'block';
        }

        // å†å²å›æµ‹
        async function runBacktest() {
            console.log('ğŸ“Š å¼€å§‹å†å²å›æµ‹...');
            
            try {
                const formData = getFormData();
                const backtestParams = {
                    stock_code: formData.stockCode,
                    months: formData.backtestMonths, // ä½¿ç”¨å›æµ‹æ—¶é—´èŒƒå›´
                    base_investment: formData.baseInvestment,
                    stop_loss_rate: formData.stopLossRate / 100, // è½¬æ¢ä¸ºå°æ•°
                    max_profit_rate: formData.maxProfitRate / 100, // è½¬æ¢ä¸ºå°æ•°
                    profit_callback_rate: formData.profitCallbackRate / 100, // è½¬æ¢ä¸ºå°æ•°
                    min_gold_change: formData.minGoldChange / 100, // è½¬æ¢ä¸ºå°æ•°
                    min_buy_amount: formData.minBuyAmount,
                    transaction_cost_rate: formData.transactionCostRate / 100, // è½¬æ¢ä¸ºå°æ•°
                    max_hold_days: formData.maxHoldDays,
                    user_id: 100001,
                    auth: 'default_user'
                };
                
                console.log('å›æµ‹å‚æ•°:', backtestParams);
                showLoading();
                
                const response = await fetch('/api/backtest', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(backtestParams)
                });

                const result = await response.json();
                console.log('å›æµ‹ç»“æœ:', result);

                hideLoading();
                    
                if (result.success) {
                    displayBacktestResult(result.backtest_result);
                } else {
                    showError('å›æµ‹å¤±è´¥: ' + result.error);
                }
            } catch (error) {
                console.error('å›æµ‹é”™è¯¯:', error);
                hideLoading();
                showError('å›æµ‹å¤±è´¥: ' + error.message);
            }
        }
        
        // æ˜¾ç¤ºå›æµ‹ç»“æœ
        function displayBacktestResult(backtestResult) {
            const strategyResult = getElementById('strategyResult');
            const strategyStats = getElementById('strategyStats');
            
            const stats = backtestResult.statistics || {};
            const period = backtestResult.backtest_period || {};
            
            // æ˜¾ç¤ºå›æµ‹ç»Ÿè®¡ä¿¡æ¯
            strategyStats.innerHTML = `
                <div class="stat-card">
                    <div class="value">${period.days || 0}</div>
                    <div class="label">å›æµ‹å¤©æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="value">${stats.total_trades || 0}</div>
                    <div class="label">æ€»äº¤æ˜“æ¬¡æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="value">Â¥${(stats.total_net_profit || 0).toFixed(2)}</div>
                    <div class="label">æ€»ç›ˆåˆ©</div>
                </div>
                <div class="stat-card">
                    <div class="value">${stats.win_trades || 0}æ¬¡</div>
                    <div class="label">ç›ˆåˆ©äº¤æ˜“</div>
                </div>
                <div class="stat-card">
                    <div class="value">${(stats.win_rate || 0).toFixed(2)}%</div>
                    <div class="label">èƒœç‡</div>
                </div>
                <div class="stat-card">
                    <div class="value">${(stats.annual_return || 0).toFixed(2)}%</div>
                    <div class="label">å¹´åŒ–æ”¶ç›Šç‡</div>
                </div>
                <div class="stat-card">
                    <div class="value">${(stats.max_drawdown || 0).toFixed(2)}%</div>
                    <div class="label">æœ€å¤§å›æ’¤</div>
                </div>
                <div class="stat-card">
                    <div class="value">Â¥${(stats.final_market_value || 0).toFixed(2)}</div>
                    <div class="label">æœ€ç»ˆèµ„äº§</div>
                </div>
            `;
            
            // æ˜¾ç¤ºå›æµ‹å›¾è¡¨
            if (backtestResult.chart_data) {
                displayChart(backtestResult.chart_data, 'strategyChartContainer', 'strategyChartSection');
            }
            
            strategyResult.style.display = 'block';
            
            // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
            showSuccess(`å†å²å›æµ‹å®Œæˆï¼å›æµ‹æœŸé—´ï¼š${period.start_date} è‡³ ${period.end_date}`);
        }

        // åˆ·æ–°æ•°æ®
        async function refreshData() {
            console.log('ğŸ”„ åˆ·æ–°æ•°æ®...');
            try {
                const formData = getFormData();
                console.log('ğŸ” åˆ·æ–°æ—¶çš„è‚¡ç¥¨ä»£ç :', formData.stockCode);
                if (!formData.stockCode) {
                    console.log('æœªé€‰æ‹©è‚¡ç¥¨ï¼Œè·³è¿‡åˆ·æ–°');
                    return;
                }
                
                const response = await fetch(`/api/current_status?stock_code=${formData.stockCode}`);
                const status = await response.json();
                
                if (status.error) {
                    console.error('è·å–çŠ¶æ€å¤±è´¥:', status.error);
                    return;
                }
                
                // æ›´æ–°åŸºç¡€ä¿¡æ¯æ˜¾ç¤º
                const basicInfoDisplay = getElementById('basicInfoDisplay');
                if (basicInfoDisplay && basicInfoDisplay.style.display !== 'none') {
                    // ç›´æ¥ä½¿ç”¨è·å–åˆ°çš„çŠ¶æ€æ•°æ®ï¼Œé¿å…é‡å¤è¯·æ±‚
                    await displayBasicInfoWithStatus(status);
                }
                
                console.log('âœ… æ•°æ®åˆ·æ–°å®Œæˆ');
            } catch (error) {
                console.error('âŒ æ•°æ®åˆ·æ–°å¤±è´¥:', error);
            }
        }

        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        function showError(message) {
            console.error('âŒ', message);
            // è¿™é‡Œå¯ä»¥æ·»åŠ é”™è¯¯æç¤ºUI
            alert('é”™è¯¯: ' + message);
        }

        // æ˜¾ç¤ºæˆåŠŸä¿¡æ¯
        function showSuccess(message) {
            console.log('âœ…', message);
            // è¿™é‡Œå¯ä»¥æ·»åŠ æˆåŠŸæç¤ºUI
            alert('æˆåŠŸ: ' + message);
        }

        // æ›´æ–°æƒé‡æ€»å’Œæ˜¾ç¤º
        function updateWeightTotal() {
            const correlation = parseInt(document.getElementById('correlationWeight').value) || 0;
            const trend = parseInt(document.getElementById('trendWeight').value) || 0;
            const volatility = parseInt(document.getElementById('volatilityWeight').value) || 0;
            const pattern = parseInt(document.getElementById('patternWeight').value) || 0;
            const volume = parseInt(document.getElementById('volumeWeight').value) || 0;
            
            const total = correlation + trend + volatility + pattern + volume;
            
            const weightTotalElement = document.getElementById('weightTotal');
            const weightStatusElement = document.getElementById('weightStatus');
            
            if (weightTotalElement) {
                weightTotalElement.textContent = total;
            }
            
            if (weightStatusElement) {
                if (total === 100) {
                    weightStatusElement.textContent = 'âœ“ æƒé‡é…ç½®æ­£ç¡®';
                    weightStatusElement.className = 'weight-status-ok';
                } else {
                    weightStatusElement.textContent = `âœ— æƒé‡æ€»å’Œåº”ä¸º100%`;
                    weightStatusElement.className = 'weight-status-error';
                }
            }
        }

        // å…¬å…±çš„APIè¯·æ±‚å‡½æ•°
        async function makeApiRequest(url, options = {}) {
            try {
                const response = await fetch(url, {
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    },
                    ...options
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                return await response.json();
            } catch (error) {
                console.error('APIè¯·æ±‚å¤±è´¥:', error);
                throw error;
            }
        }

        // é¡µé¢å¸è½½æ—¶æ¸…ç†å®šæ—¶å™¨
        window.addEventListener('beforeunload', function() {
            stopAutoRefresh();
        });
    </script>
</body>
</html>
